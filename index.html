<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Audiowide&family=Orbitron:wght@500;700&display=swap" rel="stylesheet" />
    <title>Void Skies</title>
    <style>
        :root {
            --bg:#050008; --fg:#ff99cc; --accent:#b266ff; --accent2:#9a66ff;
            --edge:rgba(178,102,255,.35); --hud-text: clamp(9px, 1vw, 12px);
            --btn-text: clamp(16px, 2vw, 20px); --btn-pad-y: clamp(12px, 1.5vw, 18px);
            --btn-pad-x: clamp(18px, 2.5vw, 24px); --maxw: 98vw;
        }
        html,body{height:100%;margin:0;background:radial-gradient(1200px 800px at 50% 40%,#330044,var(--bg));color:var(--fg);font-family:'Audiowide',ui-sans-serif,system-ui}
        #wrap{position:fixed;inset:0;display:grid;place-items:center;min-height:100svh;padding:0;}
        .stage{width:100vw; height:100svh; position:relative;display:grid;place-items:center;background:#000;border-radius:0;overflow:hidden;box-shadow:0 0 60px rgba(255,0,255,.4);container-type:inline-size;z-index:2;}
        canvas{background:transparent;border-radius:16px;touch-action:none;cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="rgba(255,255,255,0.7)" viewBox="0 0 16 16"><circle cx="8" cy="8" r="8"/></svg>'), auto;}
        
        #ui { position: absolute; inset: 0; pointer-events: none; z-index: 10; }
        .panel { pointer-events: auto; }

        #topBar{position:absolute;left:0;right:0;top:0;display:grid;grid-template-columns:1fr auto 1fr;align-items:start;padding:4px;pointer-events:none}
        #hud{display:flex;gap:8px;pointer-events:none;font-size:var(--hud-text);justify-content:center;align-items:flex-start;width:auto;max-width:none;transform:translateY(2px);grid-column:2}
        .hud-card{pointer-events:none;border:1px solid var(--edge);background:linear-gradient(180deg,rgba(150,80,255,.12),rgba(150,80,255,.06));backdrop-filter:blur(8px);padding:6px 10px;border-radius:8px;width:auto;min-width:220px}
        .hud-title{opacity:.85;font-weight:600;margin-bottom:4px;font-family:'Orbitron','Audiowide',ui-sans-serif;text-align:center;font-size:10px;color:#c49cff}
        #hudPowerup{grid-column:1;justify-self:start;margin-left:8px;min-width:150px}
        #hudEquipment{grid-column:3;justify-self:end;margin-right:8px;min-width:150px; text-align:right;}
        .bar{height:4px;width:100%;background:rgba(150,80,255,.12);border-radius:999px;overflow:hidden;border:1px solid var(--edge);margin-top:2px}
        .bar>span{display:block;height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2))}
        #announce {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            top: 70px;
            background: linear-gradient(180deg, rgba(0, 255, 150, .26), rgba(0, 255, 150, .1));
            border: 1px solid #00ff96;
            padding: 6px 10px;
            border-radius: 10px;
            font-weight: 600;
            text-shadow: 0 0 10px #00ff96;
            font-family: 'Orbitron', 'Audiowide', ui-sans-serif;
            font-size: 12px;
            color: #fff;
        }
        #diagBox{position:absolute;left:8px;top:8px;display:grid;gap:4px;pointer-events:none}
        .chip{pointer-events:auto;background:rgba(0,0,0,.7);border:1px solid var(--edge);padding:4px 8px;border-radius:8px;font-size:10px;letter-spacing:.3px;font-family:'Orbitron','Audiowide',ui-sans-serif;text-align:left;color:#c49cff}
        .btn{background:#330044;color:#ffddff;border:1px solid var(--accent);border-radius:12px;padding:var(--btn-pad-y) var(--btn-pad-x);font-size:var(--btn-text);cursor:pointer;touch-action:manipulation;-webkit-user-select:none;user-select:none;transition:all .2s; font-family: 'Orbitron', 'Audiowide', ui-sans-serif;}
        .btn:hover{background:#4c0e72;box-shadow:0 0 15px rgba(178,102,255,.5)}
        
        .panel{
            position:absolute;
            left:50%;
            top:50%;
            transform:translate(-50%,-50%);
            background:rgba(26,0,34,.95);
            border:1px solid var(--accent);
            border-radius:16px;
            padding:12px;
            width:min(600px, 90vw);
            backdrop-filter:blur(12px);
            color:#ffddff;
            box-shadow:0 0 40px rgba(178,102,255,.3);
            z-index:100;
        }
        #namePanel {
            top: 50%;
            transform: translate(-50%, -50%);
        }
        #pilotPanel {
            width: min(800px, 94vw);
            position: relative;
        }
        .close-btn {
            position: absolute;
            top: 8px;
            right: 15px;
            background: transparent;
            border: none;
            color: var(--accent);
            font-size: 20px;
            font-family: 'Orbitron', 'Audiowide', ui-sans-serif;
            font-weight: bold;
            line-height: 1;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s, transform 0.2s;
            padding: 4px;
        }
        .close-btn:hover {
            opacity: 1;
            transform: scale(1.1);
        }
        #shopPanel h2, #levelPanel h2, #scorePanel h2, #namePanel h2, #pilotPanel h2 {
            margin: 0 0 4px 0;
            padding-top: 4px;
            font-size: clamp(16px, 2vw, 20px);
            text-align: center;
        }
        #shopPanel p, #levelPanel p, #namePanel p {
            margin: 0 0 8px 0;
            text-align: center;
        }
        #shopGrid, #scorePanel div {
            max-height: 60vh; 
            overflow-y: auto;
            padding-right: 8px;
        }
        .grid{
            display:grid;
            gap:8px;
            grid-template-columns:repeat(auto-fit, minmax(140px, 1fr));
        }
        .hide{display:none!important}
        #belowBoard{width:min(98vw,var(--maxw));margin:50px auto 0;padding:8px;display:grid;gap:8px}
        #hsCard{border:1px solid var(--edge);background:linear-gradient(180deg,rgba(150,80,255,.12),rgba(150,80,255,.06));backdrop-filter:blur(8px);padding:8px;border-radius:8px}
        #hsCard h3{margin:0 0 6px 0;font-family:'Orbitron','Audiowide',ui-sans-serif;text-align:center;font-size:14px;color:#c49cff}
        #hsList{list-style:decimal;margin:0;padding:0 0 0 1rem;line-height:1.4;font-size:12px;color:#ffddff}
        
        .skill-card {
            background: radial-gradient(circle, rgba(51,0,68,1) 0%, rgba(51,0,68,0.8) 70%);
            border: 1px solid var(--accent);
            border-radius: 12px;
            padding: 12px 8px;
            cursor: pointer;
            transition: all .2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            justify-content: flex-start;
        }
        .skill-card:hover{background:rgba(85,0,120,.9);box-shadow:0 0 20px rgba(178,102,255,.6);transform:scale(1.05)}
        .skill-card.disabled{opacity:0.5;cursor:not-allowed;transform:none!important;box-shadow:none!important}
        
        .skill-icon {
            font-size: 28px;
            margin-bottom: 8px;
            line-height: 1;
        }
        .pilot-icon {
            width: 128px;
            height: 128px;
            object-fit: contain;
            margin-bottom: 8px;
        }
        .skill-title{
            font-weight:700;
            color:#c49cff;
            margin-bottom: 8px;
            font-size: 14px;
            line-height: 1.1;
        }
        .skill-desc{
            font-size:11px;
            color:#ffddff;
            margin-bottom: 8px;
            min-height: 44px;
        }
        .skill-bonuses {
            font-size: 10px;
            color: var(--accent);
            line-height: 1.4;
            margin-top: auto;
            padding-top: 8px;
            border-top: 1px solid var(--edge);
            width: 100%;
        }

        #storyBtn {
            position: absolute;
            top: 10px;
            left: 10px;
            background: transparent;
            border: 1px solid var(--accent);
            color: var(--accent);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            font-size: 18px;
            font-family: 'Orbitron', serif;
            cursor: pointer;
            line-height: 26px;
            padding: 0;
            transition: all 0.2s;
        }
        #storyBtn:hover {
            background: var(--accent);
            color: var(--bg);
            transform: scale(1.1);
        }
        #storyPanel {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 200;
            display: grid;
            place-items: center;
            padding: 20px;
            cursor: pointer;
        }
        #storyPanel p {
            max-width: 600px;
            text-align: center;
            font-size: clamp(16px, 2.5vw, 22px);
            line-height: 1.6;
            color: #ffddff;
            text-shadow: 0 0 10px var(--accent);
        }

        .fixed-btn{
            position: fixed;
            z-index: 5;
            border-radius: 10px;
            padding: var(--btn-pad-y) var(--btn-pad-x);
            background: rgba(150, 80, 255, .2);
            border: 1px solid var(--accent);
            backdrop-filter: blur(8px);
            cursor: pointer;
            font-size: var(--btn-text);
            color: #ffddff;
            height: auto;
            font-family: 'Orbitron', 'Audiowide', ui-sans-serif;
            opacity: 0.4;
            transition: opacity 0.3s ease-in-out;
        }
        .fixed-btn:hover {
            opacity: 1;
        }

        #fsEnterBtn {
            left: 20px;
            bottom: 20px;
        }
        
        #bottom-right-controls {
            position: fixed;
            right: 20px;
            bottom: 20px;
            z-index: 5;
            display: flex;
            gap: 10px;
        }
        #bottom-right-controls > .fixed-btn {
            position: static;
        }

        #menuBtn, #fsEnterBtn, #shopBtn {
            font-size: clamp(12.8px, 1.6vw, 16px);
            padding: clamp(9.6px, 1.2vw, 14.4px) clamp(14.4px, 2vw, 19.2px);
            min-width: auto;
        }

        #shopBtn {
            background: linear-gradient(180deg, rgba(255, 215, 0, 0.4), rgba(255, 165, 0, 0.2));
            border-color: #ffd700;
        }
        #pauseBtn {
            top: 50%;
            right: 15px; 
            transform: translateY(-50%);
            width: auto;
            height: auto;
            min-width: 0;
            padding: 20px 10px;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            font-size: clamp(12.8px, 1.6vw, 16px);
            z-index: 5;
            position: fixed;
        }
        .input{width:100%;padding:8px 10px;border-radius:10px;background:#17001f;color:#ffddff;border:1px solid var(--accent);font-family:'Orbitron','Audiowide',ui-sans-serif; box-sizing: border-box;}
        
        #abilityBar {
            position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 15px; z-index: 6; pointer-events: auto;
        }
        #abilityBar .ability-btn {
            position: relative; bottom: auto; left: auto; right: auto; top: auto;
            min-width: 150px; padding: clamp(10px, 1.2vw, 14px) clamp(16px, 2vw, 22px);
            font-size: clamp(14px, 1.8vw, 18px);
            background: linear-gradient(180deg, rgba(178, 102, 255, .4), rgba(178, 102, 255, .2));
            text-shadow: 0 0 8px #ff99cc;
            transition: all 0.2s ease-in-out;
            opacity: 1.0;
        }
        #abilityBar .ability-btn:not(:disabled) {
            animation: pulse-glow-ability 2s infinite;
        }
        #abilityBar .ability-btn:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 0 25px rgba(178, 102, 255, .7);
        }
        
        .shop-item-attack { border-color: #00bfff; }
        .shop-item-health { border-color: #00ff00; }
        .shop-item-utility { border-color: #ffd700; }

        @keyframes pulse-glow {
            0% { box-shadow: 0 0 15px rgba(102, 255, 178, .5); }
            50% { box-shadow: 0 0 35px rgba(102, 255, 178, 1); }
            100% { box-shadow: 0 0 15px rgba(102, 255, 178, .5); }
        }
        @keyframes pulse-glow-ability {
            0% { box-shadow: 0 0 10px rgba(178, 102, 255, .5); }
            50% { box-shadow: 0 0 20px rgba(178, 102, 255, .8); }
            100% { box-shadow: 0 0 10px rgba(178, 102, 255, .5); }
        }
        .shop-item.highlight {
            animation: pulse-glow 1.5s infinite;
            border-color: #66ffb2;
        }

        @media (max-width:820px){canvas{width:100vw;height:auto;max-height:75vh;border-radius:8px}.panel{width:min(500px,94vw)}.stage{width:98vw}#belowBoard{width:98vw}}
    </style>
</head>
<body>
    <div id="wrap">
        <div>
            <div class="stage" id="stage">
                <div id="topBar">
                    <div id="hudPowerup" class="hud-card hide"></div>
                    <div id="hud">
                        <div id="hudWaveContent" class="hud-card"></div>
                        <div id="hudPilotContent" class="hud-card"></div>
                        <div id="hudBossContent" class="hud-card hide"></div>
                    </div>
                    <div id="hudEquipment" class="hud-card hide"></div>
                    <div id="announce" class="hide" aria-live="polite"></div>
                </div>
                <canvas id="game" width="960" height="540"></canvas>
                <div id="diagBox">
                    <div class="chip">v3.7.5</div>
                    <div class="chip">FPS <span id="fps">‚Äî</span></div>
                </div>
                
                <div id="ui">
                    <div id="gameOverPanel" class="panel hide">
                        <h2 style="font-family:'Orbitron';color:var(--accent);margin-top:0">üöÄ PILOT LOST üöÄ</h2>
                        <p style="text-align:center;font-size:1.2em;color:#ffddff">FINAL SCORE: <span id="finalScore">0</span></p>
                        <div class="row" style="justify-content:center;margin-top:20px">
                            <button id="restartBtn" class="btn" type="button">FLY AGAIN</button>
                        </div>
                    </div>
                    <div id="pilotPanel" class="panel hide">
                        <button id="storyBtn" type="button">i</button>
                        <h2 style="font-family:'Orbitron';color:var(--accent)">Choose Genomic Upgrade</h2>
                        <div id="pilotsGrid" class="grid" style="grid-template-columns: repeat(3, 1fr);">
                            <div class="skill-card" data-genome="beef">
                                <div class="skill-icon"><img src="cow.png" class="pilot-icon" alt=""></div>
                                <div class="skill-title">BEEF</div>
                                <div class="skill-desc">A charging juggernaut that automatically retaliates against nearby foes.</div>
                                <div class="skill-bonuses">
                                    + Defense<br>
                                    + Special Ability
                                </div>
                            </div>
                            <div class="skill-card" data-genome="rocketman">
                                <div class="skill-icon"><img src="rockyboy.png" class="pilot-icon" alt="ROCKETMAN"></div>
                                <div class="skill-title">ROCKETMAN</div>
                                <div class="skill-desc">A master of area denial, leaving a trail of fire in his wake.</div>
                                <div class="skill-bonuses">
                                    + Special Ability<br>
                                    &nbsp;
                                </div>
                            </div>
                            <div class="skill-card" data-genome="wizard">
                                <div class="skill-icon"><img src="glasses.png.png" class="pilot-icon" alt="VOIDMANCER"></div>
                                <div class="skill-title">VOIDMANCER</div>
                                <div class="skill-desc">An ethereal pilot who can blink through the void itself.</div>
                                <div class="skill-bonuses">
                                    + Special Ability<br>
                                    &nbsp;
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="storyPanel" class="panel hide">
                        <p>When we first discovered the voidplane, one of the earliest notes was the similarity of the plane's inhabitant lifeforms to that of deep sea life on Earth.<br><br>
                        Mammalian life developed specialized spacecraft to venture within and colonize the resources of the primitive creatures.<br><br>
                        The hive responded and war ensued.</p>
                    </div>
                    <div id="namePanel" class="panel hide">
                        <h2 style="font-family:'Orbitron';color:var(--accent);margin-top:0">üíÄ CALLSIGN üíÄ</h2>
                        <p style="color:#ffddff;margin-top:0">Enter your pilot callsign (max 16 chars).</p>
                        <input id="nameInput" class="input" maxlength="16" placeholder="e.g. The Coyote" />
                        <div class="row" style="display: flex; justify-content:center;margin-top:12px"> <button id="saveName" class="btn" type="button">CONFIRM</button>
                        </div>
                    </div>
                    <div id="scorePanel" class="panel hide">
                        <h2 style="font-family:'Orbitron';color:var(--accent);margin-top:0">üèÜ Aces of the Void üèÜ</h2>
                        <div style="max-height:60vh;overflow-y:auto">
                            <ol id="hsListPopup" style="line-height:1.6;color:#ffddff"></ol>
                        </div>
                        <div style="display:flex;justify-content:center;margin-top:10px">
                            <button id="closeScores" class="btn" type="button">CLOSE</button>
                        </div>
                    </div>
                    <div id="levelPanel" class="panel hide">
                        <h2 style="font-family:'Orbitron';color:var(--accent)">‚ö° AUGMENTATION PROTOCOL ‚ö°</h2>
                        <p style="color:#ffddff">Select your neural enhancement:</p>
                        <div id="skillsGrid" class="grid"></div>
                    </div>
                    <div id="shopPanel" class="panel hide">
                        <button type="button" class="close-btn" id="closeShopTopBtn">X</button>
                        <h2 style="font-family:'Orbitron';color:var(--accent)">‚ö° MECH FORGE ‚ö°</h2>
                        <p style="color:#ffddff">Available Shards: <span id="shopShards">0</span></p>
                        <div id="shopGrid" class="grid"></div>
                        <div class="row" style="justify-content:center;margin-top:10px">
                            <button id="closeShop" class="btn" type="button">CLOSE</button>
                        </div>
                    </div>
                </div>
                
                <div id="abilityBar">
                    <button id="grenadeBtnUI" class="fixed-btn ability-btn hide" type="button">GRENADE</button>
                </div>

            </div>
            <div id="belowBoard">
                <div id="hsCard">
                    <h3>‚ö° Aces of the Void ‚ö°</h3>
                    <ol id="hsList"></ol>
                </div>
            </div>
        </div>
    </div>

    <audio id="bgmAudio" loop></audio>
    <audio id="audioExplosion" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_18210332d3.mp3?filename=explosion-6805.mp3" preload="auto"></audio>
    <audio id="audioHorn" src="https://cdn.pixabay.com/download/audio/2022/04/08/audio_f574a2539f.mp3?filename=a-war-horn-for-a-viking-army-14421.mp3" preload="auto"></audio>
    <audio id="audioHit" src="https://cdn.pixabay.com/download/audio/2021/08/04/audio_a133a82209.mp3?filename=thunk-34903.mp3" preload="auto"></audio>
    <audio id="audioTrap" src="https://cdn.pixabay.com/download/audio/2024/02/01/audio_eb6700c01b.mp3?filename=dark-trap-loop-184589.mp3" preload="auto"></audio>
    <audio id="audioDogs" src="https://cdn.pixabay.com/download/audio/2022/02/11/audio_95930e1572.mp3?filename=aggressive-dog-barking-7239.mp3" preload="auto"></audio>

    <button id="fsEnterBtn" class="fixed-btn" type="button">FULLSCREEN</button>
    <div id="bottom-right-controls">
        <button id="shopBtn" class="fixed-btn" type="button">‚ö° MECH FORGE</button>
        <button id="menuBtn" class="fixed-btn" type="button">üèÜ TOP PILOTS</button>
    </div>
    <button id="pauseBtn" class="fixed-btn hide" type="button">PAUSE</button>

<script>
(()=>{function x(d){const a=qa[d];if(a){var f=performance.now();if(d==="explosion"){if(f-da<50)return;da=f}if(d==="hit"){if(f-ea<100)return;ea=f}a.currentTime=0;a.play().catch(e=>{})}}function J(d,a){if(!(c.world.powerupCooldown>0)){var f=c.player,e=Math.max(.025,.075-(c.world.wave-1)*.0025),h=Object.keys(N),g=null;f.pilotGenome==="beef"&&(Math.random()<.25?g="shield":Math.random()<.15&&(g="repair"));f.pilotGenome==="rocketman"&&Math.random()<.2&&(e*=1.5,g="missile");f=Math.random();f>e&&!g||(c.powerups.push({x:d,
y:a,r:12,type:g&&(f<=e||Math.random()<.5)?g:h[Math.floor(Math.random()*h.length)]}),c.world.powerupCooldown=5)}}function K(){if(c.world.wave%5===0){c.enemies=[];var d=[{name:"DARTH VADER",baseHp:1300,r:55,behavior:"sentinel",color:"#eeff1b"},{name:"TRAP KING",baseHp:1500,r:50,behavior:"hex",color:"#66aaff"},{name:"CORE MALIGNUS",baseHp:1800,r:60,behavior:"malignus",color:"#2E8B57"},{name:"GEOMETRON",baseHp:2200,r:65,behavior:"construct",color:"#e03434",phase:1},{name:"Francesca",baseHp:2500,r:70,
behavior:"avian",color:"#4b0082"}][Math.floor((c.world.wave-5)/5)%5],a=d.baseHp*(1+(c.world.wave/5-1)*1.5);a*=c.world.bossHealthBonus;a*=1+(c.world.collarStacks>0?.4+(c.world.collarStacks-1)*.1:0);c.boss={...d,x:480,y:-80,hpMax:a,hp:a,t:0,fireT:0,moveT:0,vx:100,vy:30,patternPhase:0,isEnraged:!1,attackPhase:0,phaseTimer:0};c.world.bossSpawnTime=performance.now();c.boss.name==="TRAP KING"?x("trap"):c.boss.name==="CORE MALIGNUS"&&x("horn");r(`\u26a1 GUARDIAN: ${c.boss.name} \u26a1`)}else{c.enemies=[];
d=Math.floor((7+Math.floor(c.world.wave*1.8))*c.world.enemyDensityBonus);for(a=0;a<d;a++){const f=["drone","drone","hunter"];c.world.wave>3&&f.push("phantom");c.world.wave>5&&f.push("mech");c.world.wave>7&&f.push("angler");c.world.wave>9&&f.push("manta");c.enemies.push(O(f[Math.floor(Math.random()*f.length)]))}c.world.waveStartTime=performance.now();r(`\u25e2 SECTOR ${c.world.wave} \u25e3`)}}function O(d="drone"){let a={...{drone:{r:10,v:80,vx:0,hp:25,color:"#C0C0C0",xp:5,score:50,shards:1,fireRateChance:.004},
hunter:{r:20,v:100,vx:0,hp:20,color:"#DC143C",xp:8,score:80,shards:1,fireRateChance:.005},trap_king_add:{r:6,v:90,vx:0,hp:10,color:"#ffc83d",damage:5,xp:2,score:10,shards:1},phantom:{r:14,v:90,vx:0,hp:40,color:"#FFFFFF",xp:10,score:100,shards:2,fireRateChance:.006,fireCooldown:1.5},mech:{r:18,v:40,vx:0,hp:90,color:"#FF8500",xp:15,score:150,shards:3,fireRateChance:.007,attackPhase:0},construct_shard:{r:10,v:120,vx:0,hp:15,color:"#e03434",xp:3,score:30,shards:1},avian_hatchling:{r:8,v:150,vx:0,hp:20,
color:"#9370DB",xp:4,score:40,shards:1},angler:{r:22,v:30,vx:0,hp:120,color:"#00008b",xp:18,score:180,shards:4,fireRateChance:.008},manta:{r:26,v:50,vx:0,hp:150,color:"#53B6FF",xp:22,score:220,shards:5,fireRateChance:.009}}[d]};a.hp*=Math.pow(1.075,c.world.wave)*c.world.enemyHealthBonus;a.hp*=1+(c.world.collarStacks>0?.4+(c.world.collarStacks-1)*.1:0);d={...a,type:d,x:20+Math.random()*920,y:-50-Math.random()*250,hpMax:a.hp,phase:d==="phantom",t:0,fireT:a.fireCooldown||0,isBursting:!1,burstTimer:0,
stunTimer:0,knockback:null};d.type==="manta"&&(d.startX=d.x,d.amplitude=150+Math.random()*100,d.frequency=.5+Math.random()*.5);return d}function ra(d){const a=c.player;if(a.pilotGenome==="beef"&&a.beefChargeState!=="ready")if(a.beefChargeT+=d,a.beefChargeState==="charging"){var f=Math.min(a.beefChargeT/.25,1);a.x=a.beefChargeOrigin.x+(a.beefChargeTarget.x-a.beefChargeOrigin.x)*f;a.y=a.beefChargeOrigin.y+(a.beefChargeTarget.y-a.beefChargeOrigin.y)*f;f>=1&&(a.beefChargeState="returning",a.beefChargeT=
0)}else a.beefChargeState==="returning"&&(f=Math.min(a.beefChargeT/.35,1),a.x=a.beefChargeTarget.x+(a.beefChargeOrigin.x-a.beefChargeTarget.x)*f,a.y=a.beefChargeTarget.y+(a.beefChargeOrigin.y-a.beefChargeTarget.y)*f,f>=1&&(a.x=a.beefChargeOrigin.x,a.y=a.beefChargeOrigin.y,a.beefChargeState="ready",a.isInvincible=!1));else f=D.y-a.y,a.x+=(D.x-a.x)*a.speed*d*.005,a.y+=f*a.speed*d*.005,a.x=Math.max(20,Math.min(940,a.x)),a.y=Math.max(20,Math.min(520,a.y));a.pilotGenome==="wizard"&&sa(a);if(a.pilotGenome===
"beef")if(a.beefChargeCooldown>0)a.beefChargeCooldown-=d;else if(a.beefChargeState==="ready"){let g=null,l=14400;f=c.boss?[...c.enemies,c.boss]:c.enemies;f.forEach(k=>{if(!(k.dead||k.stunTimer>0)){var m=k.x-a.x,p=k.y-a.y;m=m*m+p*p;m<l&&(l=m,g=k)}});g&&(a.beefChargeCooldown=8,a.beefChargeState="charging",a.beefChargeOrigin={x:a.x,y:a.y},a.beefChargeTarget={x:g.x,y:g.y},a.beefChargeT=0,a.isInvincible=!0,c.activeEffects.push(y("beefCharge",a.beefChargeOrigin,a.beefChargeTarget)),f.forEach(k=>{if(!k.dead){var m=
k.x-g.x,p=k.y-g.y;m*m+p*p<6400&&(k.hp-=80*a.dmgMult,k.stunTimer=2.5,m=Math.atan2(k.y-a.y,k.x-a.x),k.knockback={vx:Math.cos(m)*250,vy:Math.sin(m)*250,duration:.3})}}))}if(a.pilotGenome==="rocketman"){a.flameWallCooldown||(a.flameWallCooldown=20);a.flameWallCooldown-=d;f=Math.abs(a.x-a.lastX)/d;if(a.flameWallCooldown<=0&&f>350)for(a.flameWallCooldown=20,f=0;f<10;f++)c.bullets.push({x:a.x+(f-4.5)*15,y:a.y,vx:0,vy:0,r:8+Math.random()*4,col:`rgba(255, ${100+Math.random()*100}, 0, 0.8)`,dmg:15*a.dmgMult,
life:5,isFlame:!0,pierce:!0});a.lastX=a.x}a.hasIceman&&c.iceman&&(c.iceman.x=a.x-50,c.iceman.y=a.y+40);a.fireT-=d;a.fireT<=0&&(ta(),a.fireT=a.fireRate);if(a.powerupTimers.missile&&(a.missileFireT-=d,a.missileFireT<=0)){a.missileFireT=a.pilotGenome==="rocketman"?1:1.2;let g=null,l=Infinity;(c.boss?[...c.enemies,c.boss]:c.enemies).forEach(k=>{if(!(k.dead||k.hp<=0||k.y<0)){var m=(a.x-k.x)**2+(a.y-k.y)**2;m<l&&(g=k,l=m)}});if(g){f=a.pilotGenome==="rocketman"?95*a.dmgMult*.7:95*a.dmgMult;for(var e=0;e<
a.missileVolley;e++)c.missiles.push({x:a.x+(e-(a.missileVolley-1)/2)*15,y:a.y,vx:0,vy:-300,r:4,target:g,speed:400,turnRate:5,life:0,dmg:f});if(a.hasIceman&&c.iceman)for(e=0;e<a.missileVolley;e++)c.missiles.push({x:c.iceman.x+(e-(a.missileVolley-1)/2)*15,y:c.iceman.y,vx:0,vy:-300,r:4,target:g,speed:400,turnRate:5,life:0,dmg:f*.35,isIceman:!0})}}a.shieldMax>0&&a.shield<a.shieldMax&&(a.shield=Math.min(a.shieldMax,a.shield+2*d));for(var h in a.powerupTimers)a.powerupTimers[h].remaining-=d,a.powerupTimers[h].remaining<=
0&&(h==="drones"&&(c.drones=[]),delete a.powerupTimers[h]);a.hasRearGuard&&a.rearGuardCooldown>0&&(a.rearGuardCooldown-=d,a.rearGuardCooldown<=0&&(a.rearGuardReady=!0));a.hasVoidBeam&&(a.voidBeamCooldown-=d,a.voidBeamCooldown<=0&&(c.isPaused||(c.activeEffects.push(y("gravityWell",480,270)),r("GRAVITY WELL ACTIVATED")),a.voidBeamCooldown=30));a.hasLazarusBeam&&(a.lazarusBeamCooldown-=d,a.lazarusBeamCooldown<=0&&(ua(),a.lazarusBeamCooldown=30));c.cheatInvincibilityCooldown>0&&(c.cheatInvincibilityCooldown-=
d);c.cheatDogHealCooldown>0&&(c.cheatDogHealCooldown-=d);a.x<50&&a.y<50&&c.cheatInvincibilityCooldown<=0&&(c.cheatsUsed=!0,a.isInvincible=!0,a.cheatMultishotBonus=2,r("TEST: INVINCIBILITY ACTIVE"),setTimeout(()=>{a.isInvincible=!1;a.cheatMultishotBonus=0;r("TEST: INVINCIBILITY ENDS");c.cheatInvincibilityCooldown=10},15E3),c.cheatInvincibilityCooldown=25);if(a.x>910&&a.y<50&&c.cheatDogHealCooldown<=0){c.cheatsUsed=!0;a.hp=Math.min(a.hpMax,a.hp+a.hpMax*.2);a.hasHounds||(a.hasHounds=!0);d=Math.min(2,
4-c.hounds.length);if(d>0){h=new Set(c.hounds.map(g=>g.side));f=[-1,1,-2,2];for(const g of f)d>0&&!h.has(g)&&(c.hounds.push(L(g)),d--)}c.cheatDogHealCooldown=10;r("TEST: HEAL & HOUNDS")}}function va(d){c.missiles.forEach(a=>{a.life+=d;if(a.life>6)a.dead=!0;else{if(a.target&&!a.target.dead&&a.target.hp>0){var f=a.target.x-a.x,e=a.target.y-a.y;const h=Math.sqrt(f*f+e*e);h>1&&(e=e/h*a.speed,a.vx+=(f/h*a.speed-a.vx)*a.turnRate*d,a.vy+=(e-a.vy)*a.turnRate*d)}f=Math.sqrt(a.vx*a.vx+a.vy*a.vy);f>0&&(a.vx=
a.vx/f*a.speed,a.vy=a.vy/f*a.speed);a.x+=a.vx*d;a.y+=a.vy*d;if(a.x<-20||a.x>980||a.y<-20||a.y>560)a.dead=!0;f=c.boss?[...c.enemies,c.boss]:c.enemies;for(const h of f)if(!h.dead&&B(a,h)){f=a.dmg;h===c.boss&&(f*=.1);Math.random()<c.player.critChance&&(f*=c.player.critDamage,c.activeEffects.push(y("critText",h.x,h.y)),Math.random()<.05&&J(h.x,h.y));h.hp-=f;a.dead=!0;M(a.x,a.y,!1,!0);break}}})}function wa(d){c.lasers.forEach(a=>{a.life-=d;if(a.life<=0)a.dead=!0;else{a.prevX=a.x;a.prevY=a.y;a.x+=a.vx*
d;a.y+=a.vy*d;if(a.x<a.r||a.x>960-a.r||a.y<a.r||a.y>540-a.r){const f=Math.sqrt(a.vx**2+a.vy**2);let e;e=a.x<=a.r?-Math.PI/2+Math.random()*Math.PI:a.x>=960-a.r?Math.PI/2+Math.random()*Math.PI:a.y<=a.r?Math.random()*Math.PI:Math.PI+Math.random()*Math.PI;a.x=Math.max(a.r,Math.min(960-a.r,a.x));a.y=Math.max(a.r,Math.min(540-a.r,a.y));a.vx=Math.cos(e)*f;a.vy=Math.sin(e)*f;a.hitEnemies.clear()}c.enemies.forEach(f=>{f.dead||a.hitEnemies.has(f)||!B(a,f)||(f.hp-=1E3*c.player.dmgMult,a.hitEnemies.add(f))});
c.boss&&!a.hitEnemies.has(c.boss)&&B(a,c.boss)&&(c.boss.hp-=500*c.player.dmgMult,a.hitEnemies.add(c.boss))}})}function xa(d){c.mines.forEach(a=>{if(!a.dead){a.fuse-=d;var f=a.fuse<=0;if(!f){var e=c.boss?[...c.enemies,c.boss]:c.enemies;for(var h of e)if(!h.dead&&B(a,h)){f=!0;break}}if(f){a.dead=!0;x("explosion");f=c.player;for(e=0;e<18;e++)h=e/18*2*Math.PI,c.bullets.push({x:a.x,y:a.y,vx:Math.cos(h)*300,vy:Math.sin(h)*300,r:3,col:"#ff9966",dmg:20*f.dmgMult,pierce:!1,life:.28});for(e=0;e<15;e++){h=(Math.random()-
.5)*120*Math.PI/180;const g=250+Math.random()*50;c.bullets.push({x:a.x,y:a.y,vx:Math.sin(h)*g,vy:-Math.cos(h)*g,r:3+Math.random()*2,col:`rgba(255, ${100+Math.random()*100}, 0, 0.7)`,dmg:2*f.dmgMult,life:.3,isFlame:!0})}c.activeEffects.push(y("grenadeExplosion",a.x,a.y,55))}}})}function ya(d){ra(d);c.boss&&za(d);Aa(d);va(d);wa(d);xa(d);Ba(c.enemies);c.world.powerupCooldown>0&&(c.world.powerupCooldown-=d*(1+c.player.luckBoost*2));const a=Math.pow(1.065,c.world.wave-1);c.activeEffects.forEach(e=>{e.step&&
e.step(d)});c.eBullets.forEach(e=>{e.x+=e.vx*d;e.y+=e.vy*d;e.gravity&&(e.vy+=e.gravity*d);e.life&&(e.life-=d,e.life<=0&&(e.dead=!0));if(e.x<-20||e.x>980||e.y<-20||e.y>560)e.dead=!0;if(B(e,c.player)){const h=c.player,g=e.y<h.y;h.hasRearGuard&&h.rearGuardReady&&g?(h.rearGuardReady=!1,h.rearGuardCooldown=8,e.dead=!0,c.activeEffects.push(y("rearGuardBlock"))):(S(e.dmg||10),e.dead=!0)}});c.boss&&c.boss.mines&&(c.boss.mines.forEach(e=>{e.fuse-=d;e.fuse<=0&&(c.eBullets.push({x:e.x,y:e.y,vx:0,vy:100,r:8,
col:"#ff8080",dmg:25*a}),e.dead=!0);B(e,c.player)&&(S(50*a),e.dead=!0)}),c.boss.mines=c.boss.mines.filter(e=>!e.dead));c.enemies.forEach(e=>{if(e.knockback)e.x+=e.knockback.vx*d,e.y+=e.knockback.vy*d,e.knockback.duration-=d,e.knockback.duration<=0&&(e.knockback=null);else if(e.stunTimer&&e.stunTimer>0)e.stunTimer-=d;else{if(e.type==="construct_shard"||e.type==="avian_hatchling"){var h=c.player.x-e.x,g=c.player.y-e.y,l=Math.sqrt(h*h+g*g);l>1&&(e.x+=h/l*e.v*d,e.y+=g/l*e.v*d)}else if(e.type==="angler")h=
c.player.x-e.x,Math.abs(h)>10&&(e.x+=Math.sign(h)*30*d),e.y+=e.v*d;else if(e.type==="manta")e.t+=d,e.x=e.startX+e.amplitude*Math.sin(e.t*e.frequency),e.y+=e.v*d;else{if(c.player.powerupTimers.stealth){e.fireT=1;return}e.isOrbiter?(c.boss&&(e.orbitCenter.x=c.boss.x,e.orbitCenter.y=c.boss.y),e.orbitAngle+=e.orbitSpeed*d,e.x=e.orbitCenter.x+e.orbitRadius*Math.cos(e.orbitAngle),e.y=e.orbitCenter.y+e.orbitRadius*Math.sin(e.orbitAngle)):(e.x+=(e.vx||0)*d,e.y+=e.v*d)}e.phase&&(e.x+=Math.sin(e.t*3)*80*d);
e.fireT-=d;if(e.fireT<=0&&e.y>0&&Math.random()<e.fireRateChance)switch(e.type){case "hunter":h=Math.atan2(c.player.y-e.y,c.player.x-e.x);c.eBullets.push({x:e.x,y:e.y,vx:Math.cos(h)*180,vy:Math.sin(h)*180,r:3,col:e.color,dmg:10*a});e.fireT=1;break;case "phantom":c.eBullets.push({x:e.x,y:e.y,vx:0,vy:180,r:3,col:e.color,dmg:8*a});e.fireT=e.fireCooldown;break;case "mech":e.attackPhase=(e.attackPhase||0)+1;if(e.attackPhase%2===1){l=e.x-e.r*1.2;h=e.x+e.r*1.2;g=e.y-e.r;const k=Math.atan2(c.player.y-g,c.player.x-
l);c.eBullets.push({x:l,y:g,vx:Math.cos(k)*160,vy:Math.sin(k)*160,r:4,col:e.color,dmg:12*a});l=Math.atan2(c.player.y-g,c.player.x-h);c.eBullets.push({x:h,y:g,vx:Math.cos(l)*160,vy:Math.sin(l)*160,r:4,col:e.color,dmg:12*a})}else h=c.player.x-e.x,g=Math.max(.5,Math.sqrt(h*h+(c.player.y-e.y)**2)/250),c.eBullets.push({x:e.x,y:e.y,vx:h/g,vy:(c.player.y-e.y-175*g*g)/g,r:6,col:"#ff6347",dmg:18*a,gravity:350});e.fireT=2;break;case "angler":h=Math.atan2(c.player.y-e.y,c.player.x-e.x);c.eBullets.push({x:e.x,
y:e.y,vx:Math.cos(h)*120,vy:Math.sin(h)*120,r:4,col:e.color,dmg:15*a,life:5});e.fireT=2.5;break;case "manta":for(h=-1;h<=1;h++)g=(90+h*30)*Math.PI/180,c.eBullets.push({x:e.x,y:e.y,vx:Math.cos(g)*150,vy:Math.sin(g)*150,r:3,col:e.color,dmg:12*a});e.fireT=2.8;break;default:c.eBullets.push({x:e.x,y:e.y,vx:0,vy:150,r:3,col:e.color,dmg:8*a}),e.fireT=.5}}if(e.y>570||e.x<-30||e.x>990)e.dead=!0;B(e,c.player)&&(S(15*a),c.world.shards+=e.shards,e.dead=!0)});c.bullets.forEach(e=>{e.x+=e.vx*d;e.y+=e.vy*d;e.isSwirl&&
(e.life=(e.life||0)+d,e.x+=Math.sin(e.life*15)*150*d);if(e.isFlame||e.isLevelUpPulse)e.life-=d,e.life<=0&&(e.dead=!0);if(e.x<-20||e.x>980||e.y<-20||e.y>560)e.dead=!0;c.enemies.forEach(g=>{if(!g.dead&&B(e,g)){let l=e.dmg||20;Math.random()<c.player.critChance&&(l*=c.player.critDamage,c.activeEffects.push(y("critText",g.x,g.y)),Math.random()<.05&&J(g.x,g.y));g.hp-=l;g.hp<=0&&(g.dead=!0,c.world.score+=g.score,c.world.shards+=g.shards,c.world.xp+=g.xp,c.world.kills++,J(g.x,g.y),c.player.vampirism>0&&(c.player.hp=
Math.min(c.player.hpMax,c.player.hp+l*c.player.vampirism)),M(g.x,g.y));e.explosive&&M(e.x,e.y,!1,!0);e.pierce||(e.dead=!0)}});if(c.boss&&!e.dead&&B(e,c.boss)){x("hit");var h=e.dmg||20;e.isDrone&&(h*=.4);Math.random()<c.player.critChance&&(h*=c.player.critDamage,c.activeEffects.push(y("critText",c.boss.x,c.boss.y)),Math.random()<.05&&J(c.boss.x,c.boss.y));c.boss.hp-=h;if(c.boss.hp<=0){h=(performance.now()-c.world.bossSpawnTime)/1E3;let g=1,l=!1;c.world.wave>5&&h<4?(g=1.4,c.world.bossHealthBonus*=1.4,
r("GUARDIANS ADAPTING RAPIDLY!"),l=!0,c.world.collarStacks++):h<10?(g=1.1,c.world.bossHealthBonus*=1.1,r("GUARDIANS ADAPTING!"),l=!0):h>10&&(c.world.collarStacks=0,r("ADAPTATION RESET"));l&&(c.world.enemyHealthBonus*=g,c.world.enemyDensityBonus*=1.15,setTimeout(()=>r("ENEMY SWARMS INTENSIFYING!"),1E3));c.boss.name==="TRAP KING"&&c.player.pilotGenome===null&&(c.player.pilotGenome="pending",setTimeout(Ca,1E3));c.world.score+=2E3;c.world.shards+=25;c.world.xp+=100;c.world.bosses++;c.boss=null;r("\u26a1 GUARDIAN DEFEATED \u26a1");
M(e.x,e.y,!0)}e.explosive&&M(e.x,e.y,!1,!0);e.pierce||(e.dead=!0)}});c.powerups.forEach(e=>{if(B(e,c.player)){e.dead=!0;var h=e.type;const g=c.player,l=N[h];h==="missile"&&(g.missileVolley=g.pilotGenome==="rocketman"?Math.min(5,g.missileVolley+2):2);l.type==="timed"?g.powerupTimers[h]?g.powerupTimers[h].remaining+=l.duration:(h==="drones"&&(c.drones=[{active:!0,offset:-40},{active:!0,offset:40}]),g.powerupTimers[h]={remaining:l.duration,max:l.duration}):l.type==="instant"&&(h==="shield"&&(g.hasShieldBubble=
!0),h==="repair"&&(g.hp=Math.min(g.hpMax,g.hp+30)),h==="double"&&(h=c.player,h.multishot<5?h.multishot++:(h.addFrontNext?h.multishot++:h.rearMultishot=(h.rearMultishot||0)+1,h.addFrontNext=!h.addFrontNext),r("SCATTER SHOT!")));r(l.name)}e.y>560&&(e.dead=!0)});c.player.magnetRadius>0&&c.powerups.forEach(e=>{if(!e.dead){var h=c.player.x-e.x,g=c.player.y-e.y,l=h*h+g*g;l<c.player.magnetRadius**2&&l>1&&(l=Math.sqrt(l),e.x+=h/l*350*d,e.y+=g/l*350*d)}});"bullets eBullets enemies powerups mines missiles lasers".split(" ").forEach(e=>
c[e]=c[e].filter(h=>!h.dead));c.activeEffects=c.activeEffects.filter(e=>e.isActive!==!1);c.boss||c.enemies.length!==0||(c.world.waveStartTime>0&&(performance.now()-c.world.waveStartTime)/1E3<5&&c.world.wave>1&&(c.world.enemyDensityBonus*=1.1,c.world.enemyHealthBonus*=1.05,c.world.xpMultiplier*=1.05,c.world.collarStacks++,r("SWARM INTENSITY RISING!")),c.world.wave++,c.player.hpMax+=3,c.player.hp+=3,K());let f=c.world.level*100*c.world.xpMultiplier;c.world.wave>10&&(f*=1.3);c.world.level>=8?f*=1.3:
c.world.level>=4&&(f*=1.1);f=Math.floor(f);c.world.xp>=f&&(c.world.xp-=f,c.world.level++,Da());c.player.hp<=0&&(c.isGameOver||(c.isGameOver=!0,Ea.pause(),Fa(c.world.score),r("\u25e2 NEXUS BREACH - PILOT LOST \u25e3"),document.getElementById("finalScore").textContent=c.world.score,document.getElementById("gameOverPanel").classList.remove("hide")))}function M(d,a,f=!1,e=!1){x("explosion");if(f)for(f=0;f<5;f++)setTimeout(()=>J(d,a),f*300);if(e){const h=25*c.player.dmgMult;(c.boss?[...c.enemies,c.boss]:
c.enemies).forEach(g=>{!g.dead&&(g.x-d)**2+(g.y-a)**2<3600&&(g.hp-=h)});c.activeEffects.push(y("grenadeExplosion",d,a,60))}}function Da(){r("LEVEL UP! \u26a1 CHOOSE YOUR AUGMENTATION!");G();c.player.isInvincible=!0;const d=c.player.speed*.75,a=c.player.fireRate*.5;c.player.speed+=d;c.player.fireRate-=a;var f=()=>{const g=c.player;for(let l=0;l<36;l++){const k=l/36*2*Math.PI;c.bullets.push({x:g.x,y:g.y,vx:Math.cos(k)*300,vy:Math.sin(k)*300,r:4,col:"#ffddff",dmg:30*g.dmgMult,pierce:!0,life:1.5,isLevelUpPulse:!0})}};
f();setTimeout(f,250);setTimeout(()=>{c.player.isInvincible=!1;c.player.speed-=d;c.player.fireRate+=a},3E3);const e=document.getElementById("levelPanel");f=document.getElementById("skillsGrid");var h=fa.filter(g=>g.id==="flamethrower"?c.player.flamethrowerLevel<3:!0);for(let g=h.length-1;g>0;g--){const l=Math.floor(Math.random()*(g+1));[h[g],h[l]]=[h[l],h[g]]}h=h.slice(0,3);f.innerHTML=h.map(g=>`<div class="skill-card" data-id="${g.id}"><div class="skill-icon">${g.icon}</div><div><div class="skill-title">${g.name}</div><div class="skill-desc">${g.desc}</div></div></div>`).join("");
f.querySelectorAll(".skill-card").forEach(g=>g.addEventListener("click",()=>{const l=g.dataset.id,k=fa.find(m=>m.id===l);k&&k.apply();e.classList.add("hide");E()}));e.classList.remove("hide")}function ha(){c.player=JSON.parse(JSON.stringify(ia));c.world={wave:1,score:0,shards:0,xp:0,level:1,kills:0,bosses:0,lowHealthTutorialShown:!1,bossSpawnTime:0,waveStartTime:0,enemyHealthBonus:1,bossHealthBonus:1,enemyDensityBonus:1,powerupCooldown:0,xpMultiplier:1,collarStacks:0};c.boss=null;c.bullets=[];c.eBullets=
[];c.enemies=[];c.powerups=[];c.drones=[];c.hounds=[];c.missiles=[];c.lasers=[];c.mines=[];c.activeEffects=[];c.iceman=null;c._startTs=performance.now();c.isGameOver=!1;c.cheatsUsed=!1;c.cheatInvincibilityCooldown=0;c.cheatDogHealCooldown=0;P=[];document.getElementById("gameOverPanel").classList.add("hide");document.getElementById("shopPanel").classList.add("hide");document.getElementById("levelPanel").classList.add("hide");T()}function Ga(d){b.fillStyle="#050008";b.fillRect(0,0,960,540);const a=
performance.now()/1E3;b.globalAlpha=.8;for(const f of Ha)f.y+=30*d,f.y>540&&(f.y-=540),b.fillStyle=`rgba(255,0,255,${.5+.5*Math.sin(a*2+f.pulse)})`,b.beginPath(),b.arc(f.x,f.y,f.r,0,2*Math.PI),b.fill();b.globalAlpha=.6;for(const f of Ia)f.y+=60*d,f.y>540&&(f.y-=540),b.fillStyle=`rgba(204,0,255,${.4+.6*Math.sin(a*1.5+f.pulse)})`,b.beginPath(),b.arc(f.x,f.y,Math.max(.1,f.r*(.4+.6*Math.sin(a*1.5+f.pulse))),0,2*Math.PI),b.fill();b.globalAlpha=1;c.powerups.forEach(f=>{const e=N[f.type];b.save();b.translate(f.x,
f.y);var h=.8+.2*Math.sin(performance.now()/150);b.scale(h,h);b.beginPath();b.arc(0,0,f.r+3,0,Math.PI*2);h=b.createRadialGradient(0,0,0,0,0,f.r+3);h.addColorStop(0,"#FFD70099");h.addColorStop(1,"#FFD70000");b.fillStyle=h;b.fill();b.beginPath();b.arc(0,0,f.r,0,Math.PI*2);b.fillStyle="#FFD70044";b.fill();b.strokeStyle="#FFD700";b.lineWidth=2;b.stroke();b.fillStyle="#FFFFFF";b.font="bold 16px Orbitron";b.textAlign="center";b.textBaseline="middle";b.fillText(e.icon,0,1);b.restore()});c.missiles.forEach(f=>
{b.save();b.translate(f.x,f.y);b.rotate(Math.atan2(f.vy,f.vx)+Math.PI/2);b.fillStyle=f.isIceman?"#a0e9ff":"#ffddff";b.shadowColor=f.isIceman?"#3c9aed":"#ff8080";b.shadowBlur=10;b.beginPath();b.moveTo(0,-10);b.lineTo(4,5);b.lineTo(-4,5);b.closePath();b.fill();b.shadowBlur=0;const e=8+4*Math.sin(performance.now()/50);b.fillStyle=f.isIceman?`rgba(60, 154, 237, ${.6+.4*Math.random()})`:`rgba(255, 128, 128, ${.6+.4*Math.random()})`;b.beginPath();b.moveTo(0,5);b.lineTo(3,5+e/2);b.lineTo(-3,5+e/2);b.closePath();
b.fill();b.restore()});c.eBullets.forEach(f=>{b.fillStyle=f.col;b.beginPath();b.arc(f.x,f.y,f.r,0,2*Math.PI);b.fill()});c.bullets.forEach(f=>{b.save();b.translate(f.x,f.y);b.fillStyle=f.col;b.beginPath();const e=f.r*1.5;f.isFlame||f.isSwirl||f.explosive?b.arc(0,0,f.r,0,2*Math.PI):f.isIceman?(b.moveTo(0,e),b.lineTo(e*.8,-e*.8),b.lineTo(-e*.8,-e*.8)):(b.moveTo(0,-e),b.lineTo(e*.8,e*.8),b.lineTo(-e*.8,e*.8));b.closePath();b.fill();b.restore()});c.lasers.forEach(f=>{b.save();var e=Math.atan2(f.vy,f.vx);
const h=f.x-Math.cos(e)*200;e=f.y-Math.sin(e)*200;const g=b.createLinearGradient(h,e,f.x,f.y);g.addColorStop(0,"rgba(255, 100, 100, 0)");g.addColorStop(.5,"rgba(255, 150, 150, 0.8)");g.addColorStop(1,"rgba(255, 255, 255, 1)");b.strokeStyle=g;b.lineWidth=f.r*1.5;b.lineCap="round";b.shadowColor="#ff0000";b.shadowBlur=25;b.beginPath();b.moveTo(h,e);b.lineTo(f.x,f.y);b.stroke();b.restore()});c.mines.forEach(f=>{b.save();b.translate(f.x,f.y);var e=performance.now();e=.8+.2*Math.sin(e/150);var h=f.fuse/
5;h=`rgb(255, ${100*h}, ${80*h})`;b.beginPath();b.arc(0,0,f.r*1.5*e,0,2*Math.PI);const g=b.createRadialGradient(0,0,0,0,0,f.r*1.5*e);g.addColorStop(0,h+"99");g.addColorStop(1,h+"00");b.fillStyle=g;b.fill();b.fillStyle="#333";b.beginPath();b.arc(0,0,f.r,0,2*Math.PI);b.fill();b.strokeStyle="#555";b.lineWidth=2;b.stroke();b.fillStyle=h;b.beginPath();b.arc(0,0,f.r*.4*e,0,2*Math.PI);b.fill();b.restore()});c.boss&&c.boss.mines&&c.boss.mines.forEach(f=>{b.save();b.translate(f.x,f.y);b.beginPath();b.arc(0,
0,10,0,Math.PI*2);b.fillStyle=`rgba(255, 128, 128, ${.7+.3*Math.sin(performance.now()/200)})`;b.fill();b.restore()});c.enemies.forEach(f=>{const {x:e,y:h,r:g,type:l,color:k,hp:m,hpMax:p,t:n}=f;b.save();b.translate(e,h);m<p&&m>0&&(b.fillStyle="rgba(0,0,0,0.5)",b.fillRect(-g,-g-8,2*g,3),b.fillStyle="#b266ff",b.fillRect(-g,-g-8,2*g*(m/p),3));b.lineWidth=2;b.beginPath();switch(l){case "avian_hatchling":b.fillStyle=k+"aa";b.strokeStyle=k;b.lineWidth=2;b.moveTo(0,-g*1.2);b.lineTo(g,-g*.5);b.lineTo(g,g*
.5);b.lineTo(0,g*1.2);b.lineTo(-g,g*.5);b.lineTo(-g,-g*.5);b.closePath();b.fill();b.stroke();break;case "construct_shard":b.fillStyle=k+"aa";b.strokeStyle=k;b.lineWidth=2;b.moveTo(0,-g);b.lineTo(g,0);b.lineTo(0,g);b.lineTo(-g,0);b.closePath();b.fill();b.stroke();break;case "trap_king_add":case "drone":var q=b.createLinearGradient(-g,-g,g,g);q.addColorStop(0,"#E0E0E0");q.addColorStop(1,"#A0A0A0");b.fillStyle=q;b.strokeStyle="#808080";b.beginPath();b.moveTo(-1.2*g,0);b.quadraticCurveTo(0,-g,1.2*g,0);
b.quadraticCurveTo(0,.6*g,-1.2*g,0);b.closePath();b.fill();b.stroke();b.fillStyle="#aaddff";b.strokeStyle="#FFFFFF";b.lineWidth=1;b.beginPath();b.arc(0,-.2*g,.6*g,Math.PI,0);b.fill();b.stroke();b.fillStyle=l==="trap_king_add"?"#ffc83d":"#32CD32";b.beginPath();b.ellipse(0,-.2*g,.3*g,.4*g,0,0,2*Math.PI);b.fill();b.fillStyle="#000000";b.beginPath();b.ellipse(-.1*g,-.25*g,.08*g,.15*g,-.5,0,2*Math.PI);b.ellipse(.1*g,-.25*g,.08*g,.15*g,.5,0,2*Math.PI);b.fill();break;case "hunter":b.strokeStyle="#BE2545";
b.fillStyle=k+"cc";b.lineWidth=2;b.shadowColor=k;b.shadowBlur=15;q=g*1.8;var t=g*.5;b.beginPath();var u=[];for(var w=0;w<=12;w++){var v=w/12;u.push({x:Math.sin(v*2.5*Math.PI+n*5)*t+g*Math.sin(v*Math.PI)*.5,y:(v-.5)*q})}w=[];for(v=12;v>=0;v--){const U=v/12;w.push({x:Math.sin(U*2.5*Math.PI+n*5)*t-g*Math.sin(U*Math.PI)*.5,y:(U-.5)*q})}b.moveTo(u[0].x,u[0].y);for(v=1;v<u.length;v++)b.lineTo(u[v].x,u[v].y);b.lineTo(w[0].x,w[0].y);for(u=1;u<w.length;u++)b.lineTo(w[u].x,w[u].y);b.closePath();b.fill();b.stroke();
t*=Math.sin(n*5);q*=-.5;b.fillStyle="white";b.beginPath();b.arc(t-g*.2,q,g*.1,0,2*Math.PI);b.fill();b.beginPath();b.arc(t+g*.2,q,g*.1,0,2*Math.PI);b.fill();b.shadowBlur=0;break;case "phantom":b.globalAlpha=.6+.4*Math.sin(5*n);b.strokeStyle=k;b.fillStyle=k+"99";b.moveTo(0,-.8*g);b.quadraticCurveTo(g,-.5*g,.8*g,.8*g);b.quadraticCurveTo(0,.5*g,-.8*g,.8*g);b.quadraticCurveTo(-g,-.5*g,0,-.8*g);b.closePath();b.fill();b.stroke();for(q=-1;q<=1;q++)b.beginPath(),b.moveTo(q*.4*g,.6*g),b.quadraticCurveTo(q*
.5*g,g,q*.3*g+2*Math.sin(4*n+q),1.2*g),b.stroke();break;case "mech":b.strokeStyle=k;b.fillStyle=k+"99";b.lineWidth=2;b.beginPath();b.rect(-g*.3,-g*1.4,g*.6,g*.4);b.fill();b.stroke();b.fillStyle="#ff99cc";b.beginPath();b.rect(-g*.2,-g*1.3,g*.4,g*.15);b.fill();b.fillStyle=k+"99";b.beginPath();b.moveTo(-g*1.2,-g);b.lineTo(g*1.2,-g);b.lineTo(g*.6,g*.6);b.lineTo(-g*.6,g*.6);b.closePath();b.fill();b.stroke();b.beginPath();b.rect(-g*1.6,-g*.9,g*.6,g*1.8);b.rect(g*1,-g*.9,g*.6,g*1.8);b.fill();b.stroke();
b.fillStyle=k+"cc";b.beginPath();b.arc(-g*1.3,g*1.2,g*.5,0,2*Math.PI);b.arc(g*1.3,g*1.2,g*.5,0,2*Math.PI);b.fill();b.fillStyle=k+"99";b.beginPath();b.rect(-g*.6,g*.6,g*.5,g*.7);b.rect(g*.1,g*.6,g*.5,g*.7);b.fill();b.stroke();break;case "angler":q=g/20;b.save();b.scale(q,q);b.fillStyle=k+"99";b.strokeStyle=k;b.lineWidth=2;b.beginPath();b.moveTo(-20,0);b.quadraticCurveTo(0,-18,24,0);b.quadraticCurveTo(0,16,-20,0);b.closePath();b.fill();b.stroke();b.beginPath();b.moveTo(-6,5);b.quadraticCurveTo(2,10,
10,4);b.stroke();b.beginPath();b.moveTo(8,-6);b.quadraticCurveTo(20,-24,32,-28);b.stroke();b.shadowColor="#00FFD5";b.shadowBlur=12;b.beginPath();b.arc(32,-28,4,0,Math.PI*2);b.fillStyle="#00FFD5";b.fill();b.restore();break;case "manta":q=g/36,b.save(),b.scale(q,q),b.fillStyle=k+"cc",b.strokeStyle=k,b.lineWidth=2,b.beginPath(),b.moveTo(-36,0),b.quadraticCurveTo(-8,-18,0,-8),b.quadraticCurveTo(8,-18,36,0),b.quadraticCurveTo(8,14,0,8),b.quadraticCurveTo(-8,14,-36,0),b.closePath(),b.fill(),b.stroke(),
b.beginPath(),b.moveTo(0,8),b.quadraticCurveTo(4,22,0,30),b.stroke(),b.beginPath(),b.arc(0,0,6,0,Math.PI*2),b.stroke(),b.restore()}f.stunTimer&&f.stunTimer>0&&(b.fillStyle=`rgba(255, 255, 0, ${.5+.3*Math.sin(performance.now()/100)})`,b.font="bold 12px Orbitron",b.textAlign="center",b.fillText("STUN",0,-g-12));b.restore()});c.boss&&Ja(c.boss);c.drones.forEach(f=>{const e=c.player;b.save();b.translate(e.x+f.offset,e.y+20);b.beginPath();b.moveTo(0,-8);b.lineTo(6,6);b.lineTo(-6,6);b.closePath();b.fillStyle=
"#c49cff";b.fill();b.restore()});c.hounds.forEach(f=>{b.save();b.translate(f.x,f.y);var e=performance.now()/100;b.globalAlpha=.6+.2*Math.sin(e+f.side);e=f.r;const {main:h,accent:g}=f.color;f=g==="#FFFFFF";b.fillStyle=h;b.beginPath();b.moveTo(-e,-e*.5);b.quadraticCurveTo(0,-e*1.5,e,-e*.5);b.quadraticCurveTo(e*1.2,0,e,e);b.lineTo(-e,e);b.quadraticCurveTo(-e*1.2,0,-e,-e*.5);b.closePath();b.fill();b.fillStyle=f?h:g;b.beginPath();b.moveTo(-e,-e*.4);b.lineTo(-e*.5,-e*1.2);b.lineTo(-e*.2,-e*.6);b.closePath();
b.fill();b.beginPath();b.moveTo(e,-e*.4);b.lineTo(e*.5,-e*1.2);b.lineTo(e*.2,-e*.6);b.closePath();b.fill();f&&(b.fillStyle=g,b.beginPath(),b.moveTo(-e*.6,e*.2),b.quadraticCurveTo(0,e,e*.6,e*.2),b.lineTo(0,e*.5),b.closePath(),b.fill());b.fillStyle="#FFF";b.beginPath();b.arc(-e*.4,-e*.2,e*.25,0,2*Math.PI);b.fill();b.beginPath();b.arc(e*.4,-e*.2,e*.25,0,2*Math.PI);b.fill();b.fillStyle="#000";b.beginPath();b.arc(-e*.35,-e*.15,e*.1,0,2*Math.PI);b.fill();b.beginPath();b.arc(e*.45,-e*.15,e*.1,0,2*Math.PI);
b.fill();b.fillStyle=f?h:g;b.beginPath();b.ellipse(0,e*.3,e*.5,e*.4,0,0,2*Math.PI);b.fill();b.fillStyle="#FFF";b.beginPath();b.moveTo(-e*.3,e*.5);b.lineTo(-e*.1,e*.5);b.lineTo(-e*.2,e*.9);b.closePath();b.fill();b.beginPath();b.moveTo(e*.3,e*.5);b.lineTo(e*.1,e*.5);b.lineTo(e*.2,e*.9);b.closePath();b.fill();b.restore()});c.iceman&&Ka(c.iceman);La(c.player.x,c.player.y,c.player);c.activeEffects.forEach(f=>f.draw&&f.draw());Ma(b);Na()}function S(d){if(!(c.player.isInvincible||performance.now()<ja||c.boss&&
c.boss.isInvincible))if(c.player.hasShieldBubble)c.player.hasShieldBubble=!1,c.activeEffects.push(y("shieldBreak",c.player.x,c.player.y));else{var a=c.player,f=Math.min(a.shield,d);f<d&&x("hit");a.shield-=f;d-=f;a.hp=Math.max(0,a.hp-d);a.hp>0&&a.hp<a.hpMax*.25&&a.nanoSaves>0&&(a.nanoSaves--,a.hp=Math.min(a.hpMax,a.hp+a.hpMax*.25),c.activeEffects.push(y("nanoHeal")),r("NANO SAVE ACTIVATED!"));a.hp<a.hpMax/2&&!c.world.lowHealthTutorialShown&&(c.world.lowHealthTutorialShown=!0,Oa())}}function V(d){d=
String(d??"");return d.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")}function r(d){const a=document.getElementById("announce");a.textContent=d;a.classList.remove("hide");clearTimeout(a._t);a._t=setTimeout(()=>a.classList.add("hide"),2500)}function Na(){var d=c.player,a=Math.round(d.hp/d.hpMax*100);const f=d.shieldMax>0?Math.round(d.shield/d.shieldMax*100):0,e=`HP: ${Math.round(d.hp)} / ${d.hpMax}`,h=d.shieldMax>0?`SHIELD: ${Math.round(d.shield)} / ${d.shieldMax}`:"";document.getElementById("hudPilotContent").innerHTML=
`<div class="hud-title">${c.name?`\u25e2 ${V(c.name)} \u25e3`:"\u25e2 UNIDENTIFIED \u25e3"}</div><div style="text-align:center">SCORE <b>${c.world.score}</b> \u2022 SHARDS <b>${c.world.shards}</b></div><div class="bar"><span style="width:${a}%"></span></div><div style="font-size: 9px; text-align: center; line-height: 1;">${e}</div>${d.shieldMax>0?`<div class="bar" style="margin-top:2px;"><span style="width:${f}%;background:linear-gradient(90deg,#80ffff,#66aaff)"></span></div><div style="font-size: 9px; text-align: center; line-height: 1;">${h}</div>`:
""}`;document.getElementById("hudWaveContent").innerHTML=`<div class="hud-title">\u25e2 VOID SKIES \u25e3</div><div style="text-align:center">SECTOR <b>${c.world.wave}</b> \u2022 KILLS <b>${c.world.kills}</b> \u2022 LVL <b>${c.world.level}</b></div>`;c.boss?(document.getElementById("hudBossContent").classList.remove("hide"),document.getElementById("hudBossContent").innerHTML=`<div class="hud-title">\u26a1 ${c.boss.name} \u26a1</div><div class="bar"><span style="width:${Math.round(c.boss.hp/c.boss.hpMax*
100)}%"></span></div>`):document.getElementById("hudBossContent").classList.add("hide");d=document.getElementById("hudPowerup");a=Object.keys(c.player.powerupTimers);let g="";a.length>0&&a.forEach(l=>{const k=c.player.powerupTimers[l];g+=`<div style="text-align:left;color:#FFD700;font-size:10px;margin-top:2px">${N[l].name} (${Math.ceil(k.remaining)}s)</div><div class="bar" style="height:3px"><span style="width:${Math.min(100,k.remaining/k.max*100)}%; background:#FFD700"></span></div>`});d.innerHTML=
`<div class="hud-title">\u25e2 SYSTEMS ONLINE \u25e3</div>${g}`;d.classList.toggle("hide",!g);d=document.getElementById("hudEquipment");c.player.hasLauncher||c.player.hasHounds||c.player.nanoSaves>0?(d.classList.remove("hide"),a='<div class="hud-title">\u25e2 EQUIPMENT \u25e3</div>',c.player.nanoSaves>0&&(a+=`<div>NANO SAVE [${c.player.nanoSaves}]</div>`),c.player.hasLauncher&&(a+="<div>FRAG LAUNCHER [PASSIVE]</div>"),c.player.hasHounds&&(a+="<div>GHOST HOUNDS [ACTIVE]</div>"),d.innerHTML=a):d.classList.add("hide");
d=document.getElementById("grenadeBtnUI");c.player.grenades>0?(d.classList.remove("hide"),d.textContent=`GRENADE [${c.player.grenades}]`,d.disabled=!1):d.classList.add("hide")}function Q(d){const a=[{name:"ACE PILOT",score:5E4,waves:10},{name:"VOID RUNNER",score:35E3,waves:8},{name:"STAR HUNTER",score:25E3,waves:6},{name:"NOVA STRIKER",score:18E3,waves:5},{name:"COSMIC GUARD",score:12E3,waves:4}];d=d&&d.length>0?d:a;document.getElementById("hsList").innerHTML=d.map(f=>`<li>${V(f.name)} \u2014 ${f.score} (Wave ${f.waves??
"?"})</li>`).join("");document.getElementById("hsListPopup").innerHTML=d.map((f,e)=>`<li>#${e+1} ${V(f.name)} \u2014 ${f.score} (Wave ${f.waves??"?"})</li>`).join("")}async function ka(){try{const d=await fetch("https://ignored-insight-easter-scholars.trycloudflare.com/api/leaderboard",{cache:"no-store",timeout:5E3});if(!d.ok)throw Error(`HTTP ${d.status}: ${d.statusText}`);const a=await d.json();Q(a)}catch(d){console.warn("Failed to fetch leaderboard, using offline data:",d.message),Q(null)}}async function Fa(d){if(c.cheatsUsed)r("Score not submitted: Cheats used");
else{var a=(c.name||"ROGUE").slice(0,16);try{const f=await fetch("https://ignored-insight-easter-scholars.trycloudflare.com/api/session",{method:"POST",timeout:5E3});if(!f.ok)throw Error(`Session failed: ${f.status}`);const {nonce:e}=await f.json(),h={name:a,score:Math.floor(d)||0,waves:c.world.wave|0,kills:c.world.kills|0,bosses:c.world.bosses|0,ms:Math.max(1E4,Math.floor(performance.now()-c._startTs)),nonce:e},g=await fetch("https://ignored-insight-easter-scholars.trycloudflare.com/api/submit",
{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(h),timeout:5E3});if(!g.ok)throw Error(`Submit failed: ${g.status}`);const l=await g.json();l.ok?Q(l.top10):(console.warn("Score rejected:",l.err),r(`Score rejected: ${l.err}`),ka())}catch(f){console.warn("Score submission failed, game continues offline:",f.message)}}}function ta(){const d=c.player;if(!d.beefChargeState||d.beefChargeState==="ready"){var a=d.multishot+(d.cheatMultishotBonus||0);if(d.flamethrowerLevel>0){let k,
m;switch(d.flamethrowerLevel){case 1:var f=8;var e=40;k=250;m=.35;break;case 2:f=12;e=70;k=280;m=.4;break;default:f=16,e=90,k=320,m=.5}for(var h=0;h<f;h++){var g=(Math.random()-.5)*e*Math.PI/180,l=k+Math.random()*40;c.bullets.push({x:d.x,y:d.y-12,vx:Math.sin(g)*l,vy:-Math.cos(g)*l,r:4+Math.random()*2,col:`rgba(255, ${100+Math.random()*100}, 0, 0.7)`,dmg:3*d.dmgMult,life:m,isFlame:!0})}if(d.hasIceman&&c.iceman)for(h=0;h<f;h++)g=(Math.random()-.5)*e*Math.PI/180,l=k+Math.random()*40,c.bullets.push({x:c.iceman.x,
y:c.iceman.y-12,vx:Math.sin(g)*l,vy:-Math.cos(g)*l,r:4+Math.random()*2,col:"rgba(100, 150, 255, 0.7)",dmg:3*d.dmgMult*.35,life:m,isFlame:!0,isIceman:!0})}for(f=0;f<a;f++)e=(f-(a-1)/2)*10*Math.PI/180,c.bullets.push({x:d.x+10*Math.sin(e),y:d.y-12,vx:Math.sin(e)*420,vy:-Math.cos(e)*420,r:d.explosive?5:3,col:d.explosive?"#cc99ff":"#b266ff",dmg:20*d.dmgMult,pierce:d.piercing,explosive:d.explosive});if(d.hasIceman&&c.iceman)for(f=0;f<a;f++)e=(f-(a-1)/2)*10*Math.PI/180,c.bullets.push({x:c.iceman.x+10*Math.sin(e),
y:c.iceman.y-12,vx:Math.sin(e)*420,vy:-Math.cos(e)*420,r:d.explosive?5:3,col:"#66aaff",dmg:20*d.dmgMult*.35,pierce:d.piercing,explosive:d.explosive,isIceman:!0});if(d.rearMultishot>0)for(a=0;a<d.rearMultishot;a++)f=(a-(d.rearMultishot-1)/2)*15*Math.PI/180,c.bullets.push({x:d.x+10*Math.sin(f),y:d.y+12,vx:Math.sin(f)*420,vy:Math.cos(f)*420,r:3,col:"#ffddff",dmg:15*d.dmgMult,pierce:d.piercing>0?d.piercing-1:0});c.drones.forEach(k=>c.bullets.push({x:d.x+k.offset,y:d.y+20,vx:0,vy:-420,r:3,col:"#66aaff",
dmg:20*d.dmgMult*.4,isDrone:!0}));d.hasLauncher&&(c.bullets.push({x:d.x-15,y:d.y,vx:-50,vy:-350,r:4,col:"#ff8080",dmg:5*d.dmgMult,explosive:!0,pierce:!1,life:0,isSwirl:!0}),c.bullets.push({x:d.x+15,y:d.y,vx:50,vy:-350,r:4,col:"#ff8080",dmg:5*d.dmgMult,explosive:!0,pierce:!1,life:0,isSwirl:!0}),d.hasIceman&&c.iceman&&(c.bullets.push({x:c.iceman.x-15,y:c.iceman.y,vx:-50,vy:-350,r:4,col:"#66aaff",dmg:5*d.dmgMult*.35,explosive:!0,pierce:!1,life:0,isSwirl:!0,isIceman:!0}),c.bullets.push({x:c.iceman.x+
15,y:c.iceman.y,vx:50,vy:-350,r:4,col:"#66aaff",dmg:5*d.dmgMult*.35,explosive:!0,pierce:!1,life:0,isSwirl:!0,isIceman:!0})))}}function za(d){if(c.boss){var a=c.boss;a.t+=d;a.y<100&&(a.y+=a.vy*d);var f=Math.pow(1.065,c.world.wave-1);switch(a.behavior){case "sentinel":a.y>=100&&(a.moveT+=d,a.x+=Math.sin(a.moveT*2)*200*d,a.x=Math.max(100,Math.min(860,a.x)));a.fireT-=d;if(a.fireT<=0){if(a.patternPhase%4===0)for(a.fireT=1.5,d=0;d<12;d++){var e=d*Math.PI/6+a.t;c.eBullets.push({x:a.x,y:a.y,vx:150*Math.cos(e),
vy:150*Math.sin(e),r:4,col:"#4169e1",dmg:12*f})}else a.fireT=.2,d=Math.atan2(c.player.y-a.y,c.player.x-a.x),c.eBullets.push({x:a.x,y:a.y,vx:250*Math.cos(d),vy:250*Math.sin(d),r:5,col:"#add8e6",dmg:18*f});a.patternPhase++}break;case "malignus":a.hp/a.hpMax<=.07&&!a.isEnraged&&(a.isEnraged=!0,x("horn"));a.y>=100&&(a.moveT+=d,a.x=480+380*Math.sin(a.moveT*.5));a.fireT-=d;if(a.fireT<=0)for(a.fireT=a.isEnraged?.6:.8,d=Math.floor(Math.random()*9),e=0;e<12;e++)e>=d&&e<d+3||c.eBullets.push({x:960/13*(e+1),
y:a.y,vx:0,vy:180,r:6,col:a.color,dmg:20*f});break;case "hex":Pa(d,a,f);break;case "construct":Qa(d,a,f);break;case "avian":Ra(d,a,f)}}}function Pa(d,a,f){a.y>=100&&(a.moveT+=d,a.x=192+576*Math.abs(Math.sin(a.moveT*.4)));a.fireT-=d;a.hp/a.hpMax<.5&&!a.isEnraged&&(a.isEnraged=!0,x("trap"));var e=a.isEnraged?.8:1.5;if(a.fireT<=0)switch(a.fireT=e,a.attackPhase=(a.attackPhase+1)%3,a.attackPhase){case 0:for(e=0;e<20;e++)setTimeout(()=>{c.eBullets.push({x:Math.random()*960,y:0,vx:0,vy:250,r:5,col:"#ffc83d",
dmg:15*f})},e*50);break;case 1:for(e=0;e<4;e++){const h=e<2;c.eBullets.push({x:h?0:200+(e-2)*250,y:h?100+e*150:0,vx:h?300:0,vy:h?0:300,r:4,col:"#80ffff",dmg:20*f,isLaser:!0,life:2.5})}break;case 2:a.vx=Math.sign(c.player.x-a.x)*800,setTimeout(()=>a.vx=0,500)}a.vx&&(a.x+=a.vx*d,c.eBullets.push({x:a.x,y:a.y,vx:0,vy:0,r:8,col:"#ff8080",dmg:25*f,life:1}))}function Qa(d,a,f){a.hp/a.hpMax<.5&&a.phase===1&&(a.phase=2,a.isInvincible=!0,x("horn"),c.activeEffects.push(y("bossPhaseChange",a.x,a.y)),a.attackPhase=
0,a.fireT=2,setTimeout(()=>{a.isInvincible=!1},2E3),r("GEOMETRON ENRAGED!"));a.y>=100&&(a.moveT+=d,a.x=480+360*Math.sin(a.moveT*(a.phase===1?.3:.7)));a.fireT-=d;if(a.fireT<=0)if(a.phase===1)switch(a.attackPhase=(a.attackPhase+1)%4,a.fireT=2.5,a.attackPhase){case 0:case 2:for(d=0;d<16;d++){var e=d*2*Math.PI/16+a.t*.5;c.eBullets.push({x:a.x,y:a.y,vx:180*Math.cos(e),vy:180*Math.sin(e),r:5,col:a.color,dmg:15*f})}break;case 1:case 3:for(f=3+Math.floor(c.world.wave/10),d=0;d<f;d++)e=O("construct_shard"),
e.x=a.x+(Math.random()-.5)*100,e.y=a.y+50,c.enemies.push(e)}else switch(a.attackPhase=(a.attackPhase+1)%4,a.fireT=2,a.attackPhase){case 0:case 2:d=Math.atan2(c.player.y-a.y,c.player.x-a.x);for(e=0;e<8;e++){const h=d+8*Math.PI/180*(e-3.5)*.1;c.eBullets.push({x:a.x,y:a.y,vx:350*Math.cos(h),vy:350*Math.sin(h),r:4,col:"#ff4500",dmg:22*f,life:2})}break;case 1:case 3:for(f=0;f<2;f++)d=O("construct_shard"),d.x=a.x+(f===0?-50:50),d.y=a.y+50,d.hp*=1.5,d.v*=1.3,d.color="#ff4500",c.enemies.push(d)}}function Ra(d,
a,f){a.moveT+=d;a.isDiving||(a.y=100+Math.sin(a.moveT*2)*20,a.x=480+Math.cos(a.moveT*.5)*380);a.fireT-=d;if(a.fireT<=0)switch(a.attackPhase=(a.attackPhase+1)%5,a.attackPhase){case 0:case 2:a.fireT=1.2;for(var e=0;e<7;e++){var h=Math.atan2(c.player.y-a.y,c.player.x-a.x)+(e-3)*.1;c.eBullets.push({x:a.x,y:a.y,vx:Math.cos(h)*220,vy:Math.sin(h)*220,r:4,col:a.color,dmg:18*f})}break;case 1:case 3:a.fireT=2;f=2+Math.floor(c.world.wave/15);for(e=0;e<f;e++)h=O("avian_hatchling"),h.x=a.x+(Math.random()-.5)*
80,h.y=a.y+40,c.enemies.push(h);break;case 4:a.fireT=4,a.isDiving=!0,a.diveTarget={x:c.player.x,y:c.player.y},f=a.diveTarget.x-a.x,e=a.diveTarget.y-a.y,h=Math.sqrt(f*f+e*e),a.vx=f/h*400,a.vy=e/h*400,setTimeout(()=>{a.isDiving=!1;a.vx=0;a.vy=30},1500)}a.isDiving&&(a.x+=a.vx*d,a.y+=a.vy*d)}function Ja(d){b.save();b.translate(d.x,d.y);d.isEnraged&&(b.globalAlpha=.5+.5*Math.sin(performance.now()/50));b.fillStyle="rgba(0,0,0,0.7)";b.fillRect(-60,-d.r-20,120,8);b.fillStyle=d.name==="EVIL BABYMOON"?"#ffd700":
d.color;b.fillRect(-60,-d.r-20,d.hp/d.hpMax*120,8);b.strokeStyle="#fff";b.lineWidth=1;b.strokeRect(-60,-d.r-20,120,8);if(d.behavior==="malignus"){var a=performance.now()/1E3;b.fillStyle=d.color;b.beginPath();var f=d.r*(.3+.05*Math.sin(4*a));b.arc(0,0,f,0,2*Math.PI);b.fill();b.fillStyle="white";b.beginPath();b.arc(0,0,.4*f,0,2*Math.PI);b.fill();for(f=0;f<5;f++){b.save();var e=.8*d.r;b.rotate(a*(.5+.1*f)+f*2*Math.PI/5);b.translate(e,0);b.rotate(2*a);b.fillStyle=d.color+"aa";b.strokeStyle="#FFFFFF";
b.lineWidth=2;b.beginPath();e=.3*d.r;b.moveTo(0,-e);b.lineTo(e/2,e);b.lineTo(-e/2,e);b.closePath();b.fill();b.stroke();b.restore()}}else if(d.behavior==="hex"){b.translate(0,30);f=d.r*1.5;e=d.r*2.5;a=d.r*1.5;b.fillStyle="#66aaff";b.strokeStyle="#5599e5";b.lineWidth=3;b.beginPath();b.moveTo(-f/2,-a/2);b.lineTo(f/2,-a/2);b.lineTo(e/2,a/2);b.lineTo(-e/2,a/2);b.closePath();b.fill();b.stroke();b.fillStyle="#e03434";b.strokeStyle="#c02d2d";e=d.r*.8;f*=.9;b.beginPath();b.moveTo(-f/2,-a/2);b.lineTo(-f/2+
f/4,-a/2-e);b.lineTo(0,-a/2-e/2);b.lineTo(f/2-f/4,-a/2-e);b.lineTo(f/2,-a/2);b.closePath();b.fill();b.stroke();b.fillStyle="#000";b.fillRect(-d.r*.6,-d.r*.3,d.r*.4,d.r*.15);b.fillRect(d.r*.2,-d.r*.3,d.r*.4,d.r*.15);b.fillRect(-d.r*.4,0,d.r*.8,d.r*.1);b.strokeStyle="#ffd700";b.lineWidth=8;b.beginPath();b.arc(0,0,d.r*1.1,.5,Math.PI-.5);b.stroke();b.fillStyle="#ffd700";b.strokeStyle="#daa520";b.lineWidth=3;a=d.r*.5;b.beginPath();b.moveTo(0,d.r*1.1+a);for(f=1;f<=8;f++)e=2*Math.PI/8*f,b.lineTo(a*Math.sin(e),
d.r*1.1+a*Math.cos(e));b.closePath();b.fill();b.stroke()}else{if(d.behavior==="construct"){a=d.phase===1?d.color:"#ff4500";b.fillStyle=a+"aa";b.strokeStyle=a;b.lineWidth=3;d.phase===2&&(b.shadowColor=a,b.shadowBlur=25);var h=d.r*1.2;e=d.r*1.5;f=d.r*.7;b.beginPath();b.moveTo(-h*.5,e*.5);b.lineTo(-h*.6,e*.2);b.lineTo(-h*.4,-e*.6);b.lineTo(0,-e*.5);b.lineTo(h*.4,-e*.6);b.lineTo(h*.6,e*.2);b.lineTo(h*.5,e*.5);b.closePath();b.fill();b.stroke();e=-e*.3;h*=.4;const g=.4*d.r,l=.9*d.r;b.beginPath();b.moveTo(-h,
e);b.lineTo(-h-g*.5,e+l*.2);b.lineTo(-h,e+l);b.lineTo(-h+g*.5,e+l*.8);b.closePath();b.fill();b.stroke();b.beginPath();b.moveTo(h,e);b.lineTo(h+g*.5,e+l*.2);b.lineTo(h,e+l);b.lineTo(h-g*.5,e+l*.8);b.closePath();b.fill();b.stroke();d=d.r*.2+2*Math.sin(performance.now()/200);e=b.createRadialGradient(0,-f*.1,0,0,-f*.1,d);e.addColorStop(0,"#ffffff");e.addColorStop(.3,a);e.addColorStop(1,"#ff4500");b.fillStyle=e;b.beginPath();b.arc(0,-f*.1,d,0,2*Math.PI)}else if(d.behavior==="avian")a=d.r*1.8,f=d.r*.8,
e=d.r*.4,b.fillStyle=d.color,b.strokeStyle="#e6e6fa",b.lineWidth=3,b.beginPath(),b.moveTo(0,-f/2),b.lineTo(a/2,-f/4),b.lineTo(a/2,f/4),b.lineTo(0,f/2),b.lineTo(-a/2,f/4),b.lineTo(-a/2,-f/4),b.closePath(),b.fill(),b.stroke(),b.beginPath(),b.arc(0,-f/2,e,0,2*Math.PI),b.fill(),b.stroke(),b.fillStyle="#ffd700",b.beginPath(),b.moveTo(0,-f/2-e/2),b.lineTo(e/2,-f/2+e/2),b.lineTo(-e/2,-f/2+e/2),b.closePath(),b.fill(),b.fillStyle="#ff4500",b.beginPath(),b.arc(-e/3,-f/2-e/4,e/4,0,2*Math.PI),b.arc(e/3,-f/2-
e/4,e/4,0,2*Math.PI);else{a=b.createRadialGradient(0,0,d.r*.6,0,0,d.r);a.addColorStop(0,d.color);a.addColorStop(1,"#000000");b.fillStyle=a;b.beginPath();b.arc(0,0,d.r,0,2*Math.PI);b.fill();b.strokeStyle="#888";b.lineWidth=2;b.beginPath();b.moveTo(-d.r,0);b.lineTo(d.r,0);b.stroke();for(a=1;a<6;a++)f=d.r*a/6,b.beginPath(),b.arc(0,0,d.r,Math.PI-Math.asin(f/d.r),Math.asin(f/d.r)),b.stroke(),b.beginPath(),b.arc(0,0,d.r,Math.PI+Math.asin(f/d.r),-Math.asin(f/d.r)),b.stroke();a=d.r*.3;b.fillStyle="#444";
b.beginPath();b.arc(-d.r*.4,-d.r*.4,a,0,2*Math.PI);b.fill();b.fillStyle="white";b.beginPath();b.arc(-d.r*.4,-d.r*.4,a*.4+1*Math.sin(performance.now()/150),0,2*Math.PI)}b.fill()}b.globalAlpha=1;b.restore()}function La(d,a,f){b.save();b.translate(d,a);if(f.isInvincible||f.hasShieldBubble)b.beginPath(),b.arc(0,0,24,0,2*Math.PI),d=b.createRadialGradient(0,0,18,0,0,24),d.addColorStop(0,"#9a66ff11"),d.addColorStop(1,"#9a66ff"),b.fillStyle=d,b.fill();b.beginPath();b.moveTo(0,-20);b.lineTo(12,8);b.lineTo(8,
14);b.lineTo(0,10);b.lineTo(-8,14);b.lineTo(-12,8);b.closePath();d=b.createLinearGradient(0,-20,0,14);d.addColorStop(0,"#b266ff");d.addColorStop(.5,"#7a49cc");d.addColorStop(1,"#4d2a80");b.fillStyle=d;b.fill();b.lineWidth=2;b.strokeStyle="#c49cff";b.stroke();b.strokeStyle="#b266ff";b.lineWidth=2;b.beginPath();b.moveTo(-12,5);b.lineTo(-20,-2);b.lineTo(-18,8);b.moveTo(12,5);b.lineTo(20,-2);b.lineTo(18,8);b.stroke();d=performance.now()/1E3;b.globalAlpha=.8+.2*Math.sin(10*d);b.fillStyle="#cc99ff";b.beginPath();
b.ellipse(-5,16,3,6,0,0,2*Math.PI);b.ellipse(5,16,3,6,0,0,2*Math.PI);b.fill();b.globalAlpha=1;b.fillStyle="#ffffff";b.beginPath();b.arc(0,-8,3,0,2*Math.PI);b.fill();f.hasRearGuard&&f.rearGuardReady&&(b.fillStyle=`rgba(100, 255, 255, ${.4+.3*Math.sin(performance.now()/200)})`,b.beginPath(),b.arc(0,15,8,0,2*Math.PI),b.fill());b.restore()}function y(d,a,f,e){let h={isActive:!0,life:1,maxLife:1,x:a,y:f};switch(d){case "beefCharge":h.maxLife=.4;h.origin=a;h.target=f;h.step=function(g){this.life-=g/this.maxLife;
this.life<=0&&(this.isActive=!1)};h.draw=function(){var g=1-this.life;const l=this.origin.x+(this.target.x-this.origin.x)*g,k=this.origin.y+(this.target.y-this.origin.y)*g;b.save();g>.5&&(g=(g-.5)/.5,b.strokeStyle=`rgba(255, 100, 100, ${1-g})`,b.lineWidth=5*(1-g),b.beginPath(),b.arc(this.target.x,this.target.y,80*g,0,Math.PI*2),b.stroke());b.strokeStyle=`rgba(255, 150, 150, ${this.life})`;b.lineWidth=15*this.life;b.lineCap="round";b.beginPath();b.moveTo(this.origin.x,this.origin.y);b.lineTo(l,k);
b.stroke();b.restore()};break;case "rearGuardBlock":h.maxLife=.5;h.step=function(g){this.life-=g/this.maxLife;this.life<=0&&(this.isActive=!1)};h.draw=function(){b.save();b.translate(c.player.x,c.player.y);b.strokeStyle=`rgba(100, 255, 255, ${this.life})`;b.lineWidth=3;b.beginPath();b.arc(0,5,20*(1.2-this.life),Math.PI*.2,Math.PI*.8);b.stroke();b.restore()};break;case "gravityWell":h.maxLife=7;h.life=7;h.radius=0;h.maxRadius=300;h.damagePulseT=1;h.totalDamageDealtToBoss=0;h.step=function(g){this.life-=
g;if(this.life<=0)this.isActive=!1;else{this.radius<this.maxRadius&&(this.radius+=200*g);this.damagePulseT-=g;var l=this.damagePulseT<=0;l&&(this.damagePulseT=1);var k=(this.maxRadius*.7)**2;c.enemies.forEach(n=>{if(!n.dead){var q=this.x-n.x,t=this.y-n.y,u=q*q+t*t;if(u<this.radius**2){const w=Math.sqrt(u);if(w>10){const v=n.type==="mech"||n.type==="hunter"?.7:1;n.x+=q/w*300*v*g;n.y+=t/w*300*v*g}l&&u<k&&(n.hp-=.25*c.player.dmgMult*n.hpMax)}}});if(c.boss){const n=c.boss;var m=this.x-n.x,p=this.y-n.y;
const q=m*m+p*p;if(q<this.radius**2){const t=Math.sqrt(q);t>50&&(n.x+=m/t*300*.5*g,n.y+=p/t*300*.5*g);l&&q<k&&(m=n.hpMax*.5,p=.1*c.player.dmgMult*n.hpMax,this.totalDamageDealtToBoss+p>m&&(p=m-this.totalDamageDealtToBoss),p>0&&(n.hp-=p,this.totalDamageDealtToBoss+=p))}}}};h.draw=function(){b.save();b.translate(this.x,this.y);var g=performance.now();for(let l=0;l<5;l++){const k=g/(2E3+l*200)%(2*Math.PI);b.strokeStyle=`rgba(150, 50, 255, ${this.life/this.maxLife*.5})`;b.lineWidth=2+l;b.beginPath();b.arc(0,
0,this.radius/5*(l+1),k,k+Math.PI*1.5);b.stroke()}g=b.createRadialGradient(0,0,0,0,0,this.radius*.7);g.addColorStop(0,"rgba(0,0,0,0.9)");g.addColorStop(1,"rgba(10, 0, 20, 0)");b.fillStyle=g;b.beginPath();b.arc(0,0,this.radius,0,2*Math.PI);b.fill();b.restore()};break;case "grenadeExplosion":h.maxLife=.5;h.radius=e||60;h.step=function(g){this.life-=2*g;this.life<=0&&(this.isActive=!1)};h.draw=function(){b.beginPath();b.arc(this.x,this.y,this.radius*(1-this.life),0,2*Math.PI);b.fillStyle=`rgba(255, 153, 51, ${.8*
this.life})`;b.fill()};break;case "shieldBreak":h.maxLife=.6;h.step=function(g){this.life-=1.5*g;this.life<=0&&(this.isActive=!1)};h.draw=function(){b.strokeStyle=`rgba(154, 102, 255, ${this.life})`;b.lineWidth=4;b.beginPath();b.arc(this.x,this.y,24*(1.5-this.life),0,2*Math.PI);b.stroke()};break;case "nanoHeal":h.maxLife=.7;h.step=function(g){this.life-=g/this.maxLife;this.life<=0&&(this.isActive=!1)};h.draw=function(){const g=1-this.life;b.save();b.translate(c.player.x,c.player.y);b.strokeStyle=
`rgba(0, 255, 150, ${this.life})`;b.fillStyle=`rgba(0, 255, 150, ${.3*this.life})`;b.lineWidth=4;b.beginPath();b.arc(0,0,40*g,0,2*Math.PI);b.stroke();b.fill();b.restore()};break;case "critText":h.maxLife=.6;h.text="CRITICAL!";h.step=function(g){this.life-=g/this.maxLife;this.y-=30*g;this.life<=0&&(this.isActive=!1)};h.draw=function(){b.save();b.fillStyle=`rgba(255, 215, 0, ${this.life})`;b.font="bold 14px Orbitron";b.textAlign="center";b.shadowColor="black";b.shadowBlur=4;b.fillText(this.text,this.x,
this.y);b.restore()};break;case "bossPhaseChange":h.maxLife=.8,h.radius=0,h.step=function(g){this.life-=g/this.maxLife;this.life<=0&&(this.isActive=!1);this.radius+=600*g},h.draw=function(){b.strokeStyle=`rgba(255, 255, 255, ${this.life})`;b.lineWidth=1+4*this.life;b.beginPath();b.arc(this.x,this.y,this.radius,0,2*Math.PI);b.stroke()}}return h}function Sa(){const d=c.player;for(let a=0;a<4;a++)c.mines.push({x:d.x+(a-1.5)*40,y:d.y-50,r:10,fuse:5,proxRadius:75,isWallMine:!0})}function W(){G();const d=
document.getElementById("shopPanel"),a=document.getElementById("shopGrid");document.getElementById("shopShards").textContent=c.world.shards;const f=Object.keys(X).map(k=>{const m=X[k];var p=c.player.upgradeLevels[k]||0;k==="vampirism"?(p=12+c.player.vampirismLevel*5,c.player.vampirismLevel>=m.max&&(p=Infinity)):p=m.isPremium?m.cost:p>=m.maxLevel?Infinity:m.increment?m.baseCost+p*m.increment:Math.floor(m.baseCost*Math.pow(m.scale,p));return{key:k,...m,cost:p}}),e=["mine_wall"];if(P.length===0){var h=
[...f];h.sort((k,m)=>{const p=e.includes(k.key),n=e.includes(m.key);return p&&!n?1:!p&&n?-1:k.cost-m.cost});P=h.map(k=>k.key)}var g=P.map(k=>f.find(m=>m.key===k));h="";for(const k of g){g=k.key;var l=c.player.upgradeLevels[g]||0;let m=!1,p=k.cost,n=typeof k.desc==="function"?k.desc(l):k.desc,q=k.name;if(k.isPremium)if(g==="vampirism")c.player.vampirismLevel>=k.max&&(m=!0);else if(g==="repair")c.player.hp>=c.player.hpMax&&(m=!0,n="Health is already full.");else if(g==="nano_save")c.player.nanoSaves>=
k.max&&(m=!0,n="Max charges reached.");else if(g==="mine_wall")c.mines.filter(t=>t.isWallMine).length>0&&(m=!0,n="Wall already deployed.");else if(k.isUnlock){if(g==="gravity_well"&&c.player.hasVoidBeam||g==="lazarus_beam"&&c.player.hasLazarusBeam||g==="launcher"&&c.player.hasLauncher||g==="luck_boost"&&c.player.luckBoost>0||g==="magnet_pull"&&c.player.magnetRadius>0||g==="rear_guard"&&c.player.hasRearGuard||g==="iceman"&&c.player.hasIceman)m=!0,n="Already Unlocked"}else c.player.grenades>=k.max&&
(m=!0,n="At maximum capacity");else l>=k.maxLevel&&(m=!0,n="Max Level Reached");c.world.shards<p&&(m=!0);e.includes(g)&&(m=!0,n="Under maintenance.");l=isFinite(p)?p:"---";h+=`<div class="skill-card shop-item ${m?"disabled":""} shop-item-${k.category}" data-key="${g}"><div class="skill-icon">${k.icon}</div><div><div class="skill-title">${q}</div><div class="skill-desc">${n}</div></div><div style="color:var(--accent);margin-top:4px;font-size:11px;">Cost: ${l}</div></div>`}a.innerHTML=h;a.querySelectorAll(".shop-item").forEach(k=>
{k.addEventListener("click",()=>{if(!k.classList.contains("disabled")){var m=k.dataset.key,p=X[m],n=!1;if(p.isPremium)m==="vampirism"?c.world.shards>=12+c.player.vampirismLevel*5&&(n=p.apply()):(m=p.cost,c.world.shards>=m&&(c.world.shards-=m,n=p.apply()));else{var q=c.player.upgradeLevels[m]||0;q=p.increment?p.baseCost+q*p.increment:Math.floor(p.baseCost*Math.pow(p.scale,q));c.world.shards>=q&&(c.world.shards-=q,p.effect(),c.player.upgradeLevels[m]=(c.player.upgradeLevels[m]||0)+1,n=!0)}n&&W()}})});
d.classList.remove("hide")}function Oa(){W();r("Low health! Use the Mech Forge to repair!");setTimeout(()=>{const d=document.querySelector('.shop-item[data-key="repair"]');d&&d.classList.add("highlight")},100)}function L(d){return{x:c.player.x+50*d,y:c.player.y+20,side:d,target:null,attackT:0,r:12,killCount:0,color:d===-1||d===-2?{main:"#222222",accent:"#FFFFFF"}:{main:"#F0E68C",accent:"#BDB76B"}}}function Aa(d){c.player.hasHounds&&c.hounds.forEach(a=>{if(!a.target||a.target.dead||a.target.hp<=0){let h=
null,g=Infinity;(c.boss?[...c.enemies,c.boss]:c.enemies).forEach(l=>{if(!(l.dead||l.hp<=0)){var k=(a.x-l.x)**2+(a.y-l.y)**2;k<g&&(h=l,g=k)}});a.target=h}if(a.target){var f=a.target.x-a.x,e=a.target.y-a.y;const h=Math.sqrt(f*f+e*e);h>30?(a.x+=f/h*350*d,a.y+=e/h*350*d):(a.attackT-=d,a.attackT<=0&&(a.attackT=.25,f=8*c.player.dmgMult,a.target===c.boss&&(f*=.3),!a.target.dead&&a.target.hp>0&&(a.target.hp-=f,a.target.hp<=0&&(a.killCount++,a.killCount>0&&a.killCount%12===0&&x("dogs")))))}else f=c.player.x+
a.side*50-a.x,e=c.player.y+20-a.y,Math.sqrt(f*f+e*e)>5&&(a.x+=f*5*d,a.y+=e*5*d)})}function Ka(d){const {x:a,y:f}=d;b.save();b.translate(a,f);b.globalAlpha=.6+.2*Math.sin(performance.now()/200);b.beginPath();b.moveTo(0,-20);b.lineTo(12,8);b.lineTo(8,14);b.lineTo(0,10);b.lineTo(-8,14);b.lineTo(-12,8);b.closePath();d=b.createLinearGradient(0,-20,0,14);d.addColorStop(0,"#a0e9ff");d.addColorStop(1,"#3c9aed");b.fillStyle=d;b.fill();b.lineWidth=2;b.strokeStyle="#d0f8ff";b.stroke();b.strokeStyle="#a0e9ff";
b.lineWidth=2;b.beginPath();b.moveTo(-12,5);b.lineTo(-20,-2);b.lineTo(-18,8);b.moveTo(12,5);b.lineTo(20,-2);b.lineTo(18,8);b.stroke();b.fillStyle="#ffffff";b.beginPath();b.arc(0,-8,3,0,2*Math.PI);b.fill();b.restore()}function ua(){if(c.player.hasLazarusBeam&&!c.isPaused){const d=Math.random()*2*Math.PI,a=c.player;c.lasers.push({x:a.x,y:a.y,prevX:a.x,prevY:a.y,vx:Math.cos(d)*800,vy:Math.sin(d)*800,life:6,r:12,hitEnemies:new Set})}}function la(){if(c.player.grenades>0&&!c.isPaused){x("explosion");c.player.grenades--;
const d=c.player;for(let a=0;a<36;a++){const f=a/36*2*Math.PI;c.bullets.push({x:d.x,y:d.y,vx:Math.cos(f)*400,vy:Math.sin(f)*400,r:5,col:"#ff8080",dmg:40*d.dmgMult,pierce:!0,life:.8})}c.activeEffects.push(y("shieldBreak",d.x,d.y))}}function Ta(d,a,f=200){H.push({x:d,y:a,life:f,birth:performance.now(),dead:!1})}function Ua(d,a,f,e,h=C.riftMs){I.push({x1:d,y1:a,x2:f,y2:e,birth:performance.now(),life:h,dead:!1})}function Va(d,a,f=performance.now()){if(f-Y<C.cooldownMs)return!1;var e=Math.min(C.baseDist,
C.maxFieldFrac*540),h=a.x,g=a.y;const l=Math.hypot(h,g)||1;a=d.x;var k=d.y;h=d.x+h/l*e;e=d.y+g/l*e;g=C.edgePadding;h=Math.max(g,Math.min(960-g,h));e=Math.max(g,Math.min(540-g,e));({nx:h,ny:e}={nx:h,ny:e});Ua(a,k,h,e,C.riftMs);d.x=h;d.y=e;ja=f+C.iframeMs;Y=f;Ta(h,e);return!0}function sa(d){const a=performance.now();if(!(a-Y<C.cooldownMs||A.speed()<C.whipThresholdPxPerSec)){var f=A.dir();Va(d,f,a)}}function Ba(d){for(const a of I)!a.dead&&performance.now()-a.birth>=a.life&&(a.dead=!0);for(const a of H)!a.dead&&
performance.now()-a.birth>=a.life&&(a.dead=!0);for(d=I.length-1;d>=0;d--)I[d].dead&&I.splice(d,1);for(d=H.length-1;d>=0;d--)H[d].dead&&H.splice(d,1)}function Ma(d){I.forEach(a=>{const f=(performance.now()-a.birth)/a.life;if(f>=1)a.dead=!0;else{var e=1-f;d.save();d.globalAlpha=e;d.strokeStyle="#66FFDA";d.lineWidth=4*(1-f);d.shadowColor="#66FFDA";d.shadowBlur=12*(1-f);d.beginPath();d.moveTo(a.x1,a.y1);d.lineTo(a.x2,a.y2);d.stroke();d.restore()}});H.forEach(a=>{const f=(performance.now()-a.birth)/a.life;
f>=1?a.dead=!0:(d.save(),d.globalAlpha=1-f,d.shadowColor="#66FFDA",d.shadowBlur=18*(1-f),d.beginPath(),d.arc(a.x,a.y,8+8*f,0,Math.PI*2),d.fillStyle="#66FFDA",d.fill(),d.restore())})}function Z(){return Wa.some(d=>!document.getElementById(d).classList.contains("hide"))}function G(){c.isPaused||(c.isPaused=!0,document.getElementById("pauseBtn").classList.add("hide"))}function E(){Z()||(c.isPaused=!1,document.getElementById("pauseBtn").classList.remove("hide"),document.getElementById("pauseBtn").textContent=
"PAUSE")}function Ca(){G();const d=document.getElementById("pilotPanel");d.classList.remove("hide");d.querySelectorAll(".skill-card").forEach(a=>{a.addEventListener("click",()=>{const f=a.dataset.genome;c.player.pilotGenome=f;d.classList.add("hide");if(f){var e=c.player;switch(f){case "beef":e.hpMax*=1.2;e.hp=e.hpMax;break;case "wizard":e.multishot=5}}E()},{once:!0})})}function T(){c.name?(E(),c.player.pilotGenome===null&&K()):(G(),document.getElementById("namePanel").classList.remove("hide"),document.getElementById("nameInput").value=
"",setTimeout(()=>document.getElementById("nameInput").focus(),50))}function ma(){c.cheatsUsed=!0;r("CHEAT: POWER UP!");ha();c.world.shards=250;c.player.multishot=10;K();F=""}function aa(d){const a=Math.min(.033,(d-c.last)/1E3);c.last=d;c.isGameOver||c.isPaused||Z()||ya(a);Ga(a);document.getElementById("fps").textContent=(1/a).toFixed(0);requestAnimationFrame(aa)}const B=(d,a)=>{const f=d.x-a.x,e=d.y-a.y;d=(d.r||0)+(a.r||0);return f*f+e*e<d*d},z=document.getElementById("game"),b=z.getContext("2d"),
na=document.getElementById("stage");(new ResizeObserver(()=>{var d=na.getBoundingClientRect();const a=Math.floor(d.width);d=Math.floor(d.height);const f=Math.max(1,Math.min(2,window.devicePixelRatio||1));z.style.width=a+"px";z.style.height=d+"px";z.width=Math.floor(a*f);z.height=Math.floor(d*f);b.setTransform(z.width/960,0,0,z.height/540,0,0)})).observe(na);const D={x:480,y:432},ba=d=>{const a=z.getBoundingClientRect();return{x:960/a.width*(("clientX"in d?d.clientX:d.touches[0].clientX)-a.left),y:540/
a.height*(("clientY"in d?d.clientY:d.touches[0].clientY)-a.top)}};z.addEventListener("mousemove",d=>{d=ba(d);D.x=d.x;D.y=d.y});z.addEventListener("touchstart",d=>{const a=ba(d);D.x=a.x;D.y=a.y;d.preventDefault()},{passive:!1});z.addEventListener("touchmove",d=>{const a=ba(d);D.x=a.x;D.y=a.y;d.preventDefault()},{passive:!1});const Ea=document.getElementById("bgmAudio"),qa={explosion:document.getElementById("audioExplosion"),horn:document.getElementById("audioHorn"),hit:document.getElementById("audioHit"),
trap:document.getElementById("audioTrap"),dogs:document.getElementById("audioDogs")};let da=0,ea=0;const ia={x:480,y:432,r:14,hp:100,hpMax:100,fireT:0,speed:380,dmgMult:1,fireRate:.18,vampirism:0,shield:0,shieldMax:0,multishot:1,isInvincible:!1,piercing:0,explosive:!1,hasShieldBubble:!1,powerupTimers:{},upgradeLevels:{dmg:0,speed:0,hp:0,max_shield:0,crit_chance:0,ghost_hounds:0},grenades:0,hasVoidBeam:!1,voidBeamCooldown:0,hasLazarusBeam:!1,lazarusBeamCooldown:0,hasLauncher:!1,hasHounds:!1,missileFireT:0,
nanoSaves:0,vampirismLevel:0,flamethrowerLevel:0,luckBoost:0,magnetRadius:0,hasIceman:!1,critChance:.02,critDamage:2,pilotGenome:null,missileVolley:2,hasRearGuard:!1,rearGuardCooldown:0,rearGuardReady:!0,rearMultishot:0,addFrontNext:!0,flameWallCooldown:0,lastX:480,beefChargeState:"ready",beefChargeCooldown:0,beefChargeOrigin:null,beefChargeTarget:null,beefChargeT:0},c={frame:0,last:performance.now(),isGameOver:!1,isPaused:!1,world:{wave:1,score:0,shards:0,xp:0,level:1,kills:0,bosses:0,lowHealthTutorialShown:!1,
bossSpawnTime:0,waveStartTime:0,enemyHealthBonus:1,bossHealthBonus:1,enemyDensityBonus:1,powerupCooldown:0,xpMultiplier:1,collarStacks:0},player:{...ia},boss:null,bullets:[],eBullets:[],enemies:[],powerups:[],drones:[],hounds:[],missiles:[],lasers:[],mines:[],activeEffects:[],iceman:null,_startTs:performance.now(),cheatInvincibilityCooldown:0,cheatDogHealCooldown:0,cheatsUsed:!1},fa=[{id:"dmg",name:"PLASMA CORE",icon:"\ud83d\udca5",desc:"+7% damage",apply:()=>c.player.dmgMult*=1.07},{id:"fire",name:"OVERCLOCK",
icon:"\ud83d\udd25",desc:"+10% fire rate",apply:()=>c.player.fireRate*=.9},{id:"multi",name:"SCATTER PROTOCOL",icon:"\u2604\ufe0f",desc:"+1 projectile",apply:()=>{const d=c.player;d.multishot<5?d.multishot++:(d.addFrontNext?d.multishot++:d.rearMultishot=(d.rearMultishot||0)+1,d.addFrontNext=!d.addFrontNext)}},{id:"shield",name:"VOID SHIELD",icon:"\ud83d\udee1\ufe0f",desc:"+20 regenerating shield",apply:()=>{c.player.shieldMax+=20;c.player.shield=c.player.shieldMax}},{id:"flamethrower",name:"METHANE CHAFF",
icon:"\ud83d\udd25\ud83d\udd25\ud83d\udd25",desc:"Adds a short-range Methane Chaff Cloud to your ship.",apply:()=>{c.player.flamethrowerLevel++}}],X={repair:{name:"NANO REPAIR",icon:"\ud83d\udd27",cost:3,isPremium:!0,category:"health",apply:()=>c.player.hp<c.player.hpMax?(c.player.hp=Math.min(c.player.hpMax,c.player.hp+c.player.hpMax*.25),!0):!1,desc:()=>"Restore 25% of max HP."},vampirism:{name:"VAMPIRIC ROUNDS",icon:"\ud83e\ude78",isPremium:!0,max:4,category:"utility",apply:()=>{const d=c.player,
a=12+d.vampirismLevel*5;return c.world.shards>=a&&d.vampirismLevel<4?(c.world.shards-=a,d.vampirismLevel++,d.vampirism+=.03,d.dmgMult+=.04,!0):!1},desc:()=>{const d=c.player;return d.vampirismLevel>=4?`Max Level Reached (${(d.vampirism*100).toFixed(0)}% Lifesteal, +${d.vampirismLevel*4}% Dmg)`:`+3% lifesteal, +4% dmg. Cost: ${12+d.vampirismLevel*5}`}},hp:{name:"MAX HP",icon:"\u2764\ufe0f",baseCost:20,scale:1.4,maxLevel:10,category:"health",effect:()=>{c.player.hpMax+=10;c.player.hp+=10},desc:d=>`+10 Max HP (Lvl ${d+
1})`},nano_save:{name:"NANO SAVE",icon:"\ud83d\udcbe",cost:25,isPremium:!0,max:3,category:"utility",apply:()=>c.player.nanoSaves<3?(c.player.nanoSaves++,!0):!1,desc:()=>`Auto-heals on low HP. Charges: ${c.player.nanoSaves}/3`},luck_boost:{name:"LUCK BOOST",icon:"\ud83c\udf40",baseCost:25,scale:2,maxLevel:5,category:"utility",effect:d=>{c.player.luckBoost=(c.player.luckBoost||0)+.15/Math.pow(2,d)},desc:d=>`+${(.15/Math.pow(2,d)*100).toFixed(1)}% drop chance (Lvl ${d+1})`},dmg:{name:"DAMAGE",icon:"\ud83d\udcaa",
baseCost:25,scale:1.5,maxLevel:10,category:"attack",effect:()=>c.player.dmgMult*=1.07,desc:d=>`+7% Damage (Lvl ${d+1})`},crit_chance:{name:"SHINOBI REFLEXES",icon:"\ud83e\udd77",baseCost:20,increment:12,maxLevel:10,category:"attack",effect:()=>{c.player.critChance*=1.5;c.player.critDamage*=1.5},desc:d=>`+50% Crit Chance & Dmg (Lvl ${d+1})`},speed:{name:"SPEED",icon:"\ud83d\ude80",baseCost:30,scale:1.6,maxLevel:8,category:"utility",effect:()=>c.player.speed*=1.1,desc:d=>`+10% Speed (Lvl ${d+1})`},
grenade:{name:"NOVA GRENADE",icon:"\ud83d\udca5\ud83d\udca3\ud83d\udca5",cost:35,isPremium:!0,max:3,category:"attack",apply:()=>c.player.grenades<3?(c.player.grenades++,!0):!1,desc:()=>"Buy 1 (Max 3)"},max_shield:{name:"MAX SHIELD",icon:"\ud83d\udee1\ufe0f",baseCost:40,scale:1.8,maxLevel:5,category:"health",effect:()=>{c.player.shieldMax+=25;c.player.shield+=25},desc:d=>`+25 Max Shield (Lvl ${d+1})`},mine_wall:{name:"MINE WALL",icon:"\ud83d\udca3",cost:40,isPremium:!0,max:2,category:"attack",apply:()=>
c.mines.filter(d=>d.isWallMine).length>0?!1:(Sa(),!0),desc:()=>"Deploy a wall of mines."},rear_guard:{name:"AFT FLANKSHIELD",icon:"\ud83d\udee1\ufe0f\u2728",baseCost:65,scale:2,maxLevel:2,category:"utility",effect:d=>{d===0?c.player.hasRearGuard=!0:c.player.rearGuardCooldown=6},desc:d=>d===0?"Blocks one enemy volley from behind every 8s.":"Reduce cooldown to 6s."},launcher:{name:"FRAG LAUNCHER",icon:"\ud83d\udca5",baseCost:50,scale:2,maxLevel:3,category:"attack",effect:()=>{c.player.upgradeLevels.launcher=
(c.player.upgradeLevels.launcher||0)+1;c.player.hasLauncher=!0},desc:d=>`+2 projectiles (Lvl ${d+1})`},iceman:{name:"THE ICEMAN",icon:"\u2744\ufe0f",cost:59,isPremium:!0,isUnlock:!0,category:"utility",apply:()=>c.player.hasIceman?!1:(c.player.hasIceman=!0,c.iceman={x:c.player.x,y:c.player.y+50,t:0},!0),desc:()=>"A clone mirrors your attacks."},lazarus_beam:{name:"LORD LAZARUS",icon:"\u2622\ufe0f\u2604\ufe0f\u2622\ufe0f",cost:75,isPremium:!0,isUnlock:!0,category:"attack",apply:()=>c.player.hasLazarusBeam?
!1:(c.player.hasLazarusBeam=!0,c.player.lazarusBeamCooldown=15,!0),desc:()=>"Lazarus periodically smites your foes."},magnet_pull:{name:"GRAV-PULSE",icon:"\ud83e\uddf2",cost:45,isPremium:!0,isUnlock:!0,category:"utility",apply:()=>c.player.magnetRadius<=0?(c.player.magnetRadius=150,!0):!1,desc:()=>"Pulls in nearby powerups."},gravity_well:{name:"GRAVITY WELL",icon:"\ud83d\udd73\ufe0f",cost:100,isPremium:!0,isUnlock:!0,category:"attack",apply:()=>c.player.hasVoidBeam?!1:(c.player.hasVoidBeam=!0,c.player.voidBeamCooldown=
15,!0),desc:()=>"Unleashes a singularity that traps and crushes foes."},ghost_hounds:{name:"GHOST HOUNDS",icon:"\ud83d\udc7b\ud83d\udc3a",baseCost:75,scale:2,maxLevel:2,category:"attack",effect:()=>{c.player.hasHounds?(c.hounds.push(L(-2)),c.hounds.push(L(2))):(c.player.hasHounds=!0,c.hounds=[L(-1),L(1)]);x("dogs")},desc:d=>d===0?"Unlocks 2 spectral hounds.":d===1?"Add 2 more hounds.":"Max hounds reached."}},N={"double":{name:"SCATTER SHOT",icon:"\u2b06\ufe0f",duration:0,type:"instant"},drones:{name:"SIDE DRONES",
icon:"\ud83d\ude81",duration:15,type:"timed"},shield:{name:"SHIELD BUBBLE",icon:"\ud83d\udee1\ufe0f",duration:0,type:"instant"},repair:{name:"REPAIR KIT",icon:"\u2764\ufe0f",duration:0,type:"instant"},missile:{name:"HOMING MISSILES",icon:"\ud83d\ude80",duration:20,type:"timed"}},Ha=Array.from({length:100},()=>({x:Math.random()*960,y:Math.random()*540,r:Math.random()*1.5,pulse:Math.random()*10})),Ia=Array.from({length:80},()=>({x:Math.random()*960,y:Math.random()*540,r:Math.random()*2,pulse:Math.random()*
10}));let P=[];const C={cooldownMs:3500,baseDist:200,maxFieldFrac:.25,iframeMs:220,riftMs:600,whipThresholdPxPerSec:1200,edgePadding:6};let Y=-9999,ja=0;const I=[],H=[],A={x:0,y:0,vx:0,vy:0,t:performance.now(),init(d){window.addEventListener("mousemove",a=>{const f=performance.now(),e=Math.max(1,f-A.t),h=a.clientX-d.getBoundingClientRect().left;a=a.clientY-d.getBoundingClientRect().top;const g=(a-A.y)/(e/1E3);A.vx=(h-A.x)/(e/1E3);A.vy=g;A.x=h;A.y=a;A.t=f},{passive:!0})},speed(){return Math.hypot(this.vx,
this.vy)},dir(){const d=this.speed()||1;return{x:this.vx/d,y:this.vy/d}}},Wa="namePanel pilotPanel scorePanel levelPanel shopPanel storyPanel".split(" ");document.getElementById("restartBtn").addEventListener("click",ha);document.getElementById("saveName").addEventListener("click",()=>{const d=(document.getElementById("nameInput").value||"").slice(0,16).trim();d&&(c.name=d,document.getElementById("namePanel").classList.add("hide"),c.player.pilotGenome===null&&K(),E())});const ca=()=>{document.getElementById("shopPanel").classList.add("hide");
E();const d=document.querySelector(".shop-item.highlight");d&&d.classList.remove("highlight")};document.getElementById("closeShop").addEventListener("click",ca);document.getElementById("closeShopTopBtn").addEventListener("click",ca);document.getElementById("shopBtn").addEventListener("click",()=>{document.getElementById("shopPanel").classList.contains("hide")?W():ca()});const oa=()=>{document.getElementById("scorePanel").classList.add("hide");E()};document.getElementById("closeScores").addEventListener("click",
oa);document.getElementById("menuBtn").addEventListener("click",()=>{document.getElementById("scorePanel").classList.contains("hide")?(G(),document.getElementById("scorePanel").classList.remove("hide")):oa()});document.getElementById("fsEnterBtn").addEventListener("click",()=>{const d=document.documentElement;document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen():d.requestFullscreen?d.requestFullscreen():d.webkitRequestFullscreen?d.webkitRequestFullscreen():d.msRequestFullscreen&&
d.msRequestFullscreen()});document.getElementById("pauseBtn").addEventListener("click",()=>{c.isGameOver||Z()||(c.isPaused=!c.isPaused,document.getElementById("pauseBtn").textContent=c.isPaused?"RESUME":"PAUSE")});document.getElementById("grenadeBtnUI").addEventListener("click",la);document.getElementById("storyBtn").addEventListener("click",d=>{d.stopPropagation();G();document.getElementById("storyPanel").classList.remove("hide")});document.getElementById("storyPanel").addEventListener("click",()=>
{document.getElementById("storyPanel").classList.add("hide");document.getElementById("pilotPanel").classList.contains("hide")&&E()});document.getElementById("nameInput").addEventListener("keydown",d=>{d.key==="Enter"&&(d=(document.getElementById("nameInput").value||"").slice(0,16).trim())&&(c.name=d,document.getElementById("namePanel").classList.add("hide"),c.player.pilotGenome===null&&K(),E())});document.getElementById("namePanel").addEventListener("click",d=>{d.target.id!=="nameInput"&&d.target.id!==
"saveName"&&document.getElementById("nameInput").blur()});let F="",R=0,pa=0;document.getElementById("diagBox").children[0].addEventListener("click",()=>{const d=performance.now();d-pa>500&&(R=0);pa=d;R++;R>=3&&(ma(),R=0)});addEventListener("keydown",d=>{const a=d.key.toLowerCase();document.activeElement.tagName!=="INPUT"&&(/[a-z]/.test(a)?(F+=a,F.length>10&&(F=F.substring(F.length-10)),F.endsWith("power")&&ma()):a!==" "&&a!=="b"&&(F=""),a===" "&&(d.preventDefault(),la()))});try{A.init(z),T(),ka(),
requestAnimationFrame(aa)}catch(d){console.error("Game initialization failed:",d);try{Q(null),T(),requestAnimationFrame(aa),console.log("Game started in offline mode")}catch(a){console.error("Critical startup failure:",a),alert("Game failed to start. Please refresh the page.")}}})();

</script>

</body>
</html>
