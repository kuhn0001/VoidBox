<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Audiowide&family=Orbitron:wght@500;700&display=swap" rel="stylesheet" />
    <title>Void Skies</title>
    <style>
        :root {
            --bg:#050008; --fg:#ff99cc; --accent:#b266ff; --accent2:#9a66ff;
            --edge:rgba(178,102,255,.35); --hud-text: clamp(9px, 1vw, 12px);
            --btn-text: clamp(12px, 1.3vw, 16px); --btn-pad-y: clamp(6px, 0.8vw, 10px);
            --btn-pad-x: clamp(10px, 1.5vw, 14px); --maxw: 95vw;
        }
        html,body{height:100%;margin:0;background:radial-gradient(1200px 800px at 50% 40%,#330044,var(--bg));color:var(--fg);font-family:'Audiowide',ui-sans-serif,system-ui}
        #wrap{position:fixed;inset:0;display:grid;place-items:center;min-height:100svh;padding:calc(8px + env(safe-area-inset-top)) calc(8px + env(safe-area-inset-right)) calc(8px + env(safe-area-inset-bottom)) calc(8px + env(safe-area-inset-left))}
        .stage{width:min(95vw,var(--maxw));aspect-ratio:16/9;position:relative;display:grid;place-items:center;background:#000;border-radius:12px;overflow:hidden;box-shadow:0 0 60px rgba(255,0,255,.4);container-type:inline-size}
        canvas{background:transparent;border-radius:16px;touch-action:none;cursor:none}
        
        #ui { position: absolute; inset: 0; pointer-events: none; z-index: 10; }
        .panel { pointer-events: auto; }

        #topBar{position:absolute;left:0;right:0;top:0;display:grid;place-items:center;padding:4px;pointer-events:none}
        #hud{display:flex;gap:8px;pointer-events:none;font-size:var(--hud-text);justify-content:center;align-items:flex-start;width:auto;max-width:none;transform:translateY(2px)}
        .hud-card{pointer-events:none;border:1px solid var(--edge);background:linear-gradient(180deg,rgba(150,80,255,.12),rgba(150,80,255,.06));backdrop-filter:blur(8px);padding:6px 10px;border-radius:8px;width:auto;min-width:220px}
        .hud-title{opacity:.85;font-weight:600;margin-bottom:4px;font-family:'Orbitron','Audiowide',ui-sans-serif;text-align:center;font-size:10px;color:#c49cff}
        .bar{height:4px;width:100%;background:rgba(150,80,255,.12);border-radius:999px;overflow:hidden;border:1px solid var(--edge);margin-top:2px}
        .bar>span{display:block;height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2))}
        #announce{position:absolute;left:50%;transform:translateX(-50%);top:40px;background:linear-gradient(180deg,rgba(150,80,255,.26),rgba(150,80,255,.1));border:1px solid var(--accent);padding:6px 10px;border-radius:10px;font-weight:600;text-shadow:0 0 10px var(--accent);font-family:'Orbitron','Audiowide',ui-sans-serif;font-size:12px;color:#fff}
        #diagBox{position:absolute;right:8px;bottom:8px;display:grid;gap:4px;pointer-events:none}
        .chip{pointer-events:auto;background:rgba(0,0,0,.7);border:1px solid var(--edge);padding:4px 8px;border-radius:8px;font-size:10px;letter-spacing:.3px;font-family:'Orbitron','Audiowide',ui-sans-serif;text-align:right;color:#c49cff}
        .btn{background:#330044;color:#ffddff;border:1px solid var(--accent);border-radius:12px;padding:var(--btn-pad-y) var(--btn-pad-x);font-size:var(--btn-text);cursor:pointer;touch-action:manipulation;-webkit-user-select:none;user-select:none;transition:all .2s}
        .btn:hover{background:#4c0e72;box-shadow:0 0 15px rgba(178,102,255,.5)}
        .panel{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:rgba(26,0,34,.95);border:1px solid var(--accent);border-radius:16px;padding:20px;width:min(900px,92vw);backdrop-filter:blur(12px);color:#ffddff;box-shadow:0 0 40px rgba(178,102,255,.3)}
        .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
        .grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
        .hide{display:none!important}
        #belowBoard{width:min(95vw,var(--maxw));margin:8px auto 0;padding:8px;display:grid;gap:8px}
        #hsCard{border:1px solid var(--edge);background:linear-gradient(180deg,rgba(150,80,255,.12),rgba(150,80,255,.06));backdrop-filter:blur(8px);padding:8px;border-radius:8px}
        #hsCard h3{margin:0 0 6px 0;font-family:'Orbitron','Audiowide',ui-sans-serif;text-align:center;font-size:14px;color:#c49cff}
        #hsList{list-style:decimal;margin:0;padding:0 0 0 1rem;line-height:1.4;font-size:12px;color:#ffddff}
        .skill-card{background:rgba(51,0,68,.8);border:1px solid var(--accent);border-radius:8px;padding:10px;cursor:pointer;transition:all .2s}
        .skill-card:hover{background:rgba(85,0,120,.9);box-shadow:0 0 20px rgba(178,102,255,.6);transform:scale(1.05)}
        .skill-title{font-weight:700;color:#c49cff;margin-bottom:4px}
        .skill-desc{font-size:11px;color:#ffddff}
        .fixed-btn{position:fixed;bottom:10px;z-index:5;border-radius:10px;padding:8px 10px;background:rgba(150,80,255,.2);border:1px solid var(--accent);backdrop-filter:blur(8px);cursor:pointer;font-size:12px;color:#ffddff}
        #menuBtn{right:10px;}
        #fsEnterBtn{left:10px;}
        #shopBtn{right:100px; top:10px;}
        #pauseBtn{top:10px;right:10px;}
        #shopBtn {
            position: fixed;
            top: 10px;
            right: 100px;
            z-index: 5;
            border-radius: 10px;
            padding: 8px 10px;
            background: rgba(150, 80, 255, .2);
            border: 1px solid var(--accent);
            backdrop-filter: blur(8px);
            cursor: pointer;
            font-size: 12px;
            color: #ffddff;
            height: auto;
        }

/* Updated styles for other fixed buttons */
        .fixed-btn {
            position: fixed;
            bottom: 10px;
            z-index: 5;
            border-radius: 10px;
            padding: 8px 10px;
            background: rgba(150, 80, 255, .2);
            border: 1px solid var(--accent);
            backdrop-filter: blur(8px);
            cursor: pointer;
            font-size: 12px;
            color: #ffddff;
        }

        #menuBtn {
            right: 10px;
        }

        #fsEnterBtn {
            left: 10px;
        }

        #pauseBtn {
            top: 10px;
            right: 10px;
        }
        .input{width:100%;padding:8px 10px;border-radius:10px;background:#17001f;color:#ffddff;border:1px solid var(--accent);font-family:'Orbitron','Audiowide',ui-sans-serif}
        @media (max-width:820px){canvas{width:100vw;height:auto;max-height:75vh;border-radius:8px}.panel{width:min(700px,94vw)}.stage{width:98vw}#belowBoard{width:98vw}}
    </style>
</head>
<body>
    <div id="wrap">
        <div>
            <div class="stage" id="stage">
                <div id="topBar"><div id="hud"><div id="hudWaveContent" class="hud-card"></div><div id="hudPilotContent" class="hud-card"></div><div id="hudBossContent" class="hud-card hide"></div></div><div id="announce" class="hide" aria-live="polite"></div></div>
                <canvas id="game" width="960" height="540"></canvas>
                <div id="diagBox"><div class="chip"> v2.5.3</div><div class="chip">FPS <span id="fps">‚Äî</span></div></div>
                
                <div id="ui">
                    <div id="gameOverPanel" class="panel hide"><h2 style="font-family:'Orbitron';color:var(--accent);margin-top:0">üöÄ PILOT LOST üöÄ</h2><p style="text-align:center;font-size:1.2em;color:#ffddff">FINAL SCORE: <span id="finalScore">0</span></p><div class="row" style="justify-content:center;margin-top:20px"><button id="restartBtn" class="btn" type="button">FLY AGAIN</button></div></div>
                    <div id="namePanel" class="panel hide"><h2 style="font-family:'Orbitron';color:var(--accent);margin-top:0">ü™™ CALLSIGN</h2><p style="color:#ffddff;margin-top:0">Enter your pilot callsign (max 16 chars).</p><input id="nameInput" class="input" maxlength="16" placeholder="e.g. NIGHTWRAITH" /><div class="row" style="justify-content:flex-end;margin-top:12px"><button id="saveName" class="btn" type="button">CONFIRM</button></div></div>
                    <div id="scorePanel" class="panel hide"><h2 style="font-family:'Orbitron';color:var(--accent);margin-top:0">üèÜ ACE PILOTS üèÜ</h2><div style="max-height:60vh;overflow-y:auto"><ol id="hsListPopup" style="line-height:1.6;color:#ffddff"></ol></div><div style="display:flex;justify-content:flex-end;margin-top:10px"><button id="closeScores" class="btn" type="button">CLOSE</button></div></div>
                    <div id="levelPanel" class="panel hide"><h2 style="font-family:'Orbitron';color:var(--accent)">‚ö° AUGMENTATION PROTOCOL ‚ö°</h2><p style="color:#ffddff">Select your neural enhancement:</p><div id="skillsGrid" class="grid"></div></div>
                    <div id="shopPanel" class="panel hide"><h2 style="font-family:'Orbitron';color:var(--accent)">üîß MECH FORGE üîß</h2><p style="color:#ffddff">Available Shards: <span id="shopShards">0</span></p><div id="shopGrid" class="grid"></div><div class="row" style="justify-content:flex-end;margin-top:10px"><button id="closeShop" class="btn" type="button">CLOSE</button></div></div>
                </div>
            </div>
            <div id="belowBoard"><div id="hsCard"><h3>‚ö° ACE PILOTS ‚ö°</h3><ol id="hsList"></ol></div></div>
        </div>
    </div>

    <audio id="bgmAudio" loop></audio>
    <button id="menuBtn" class="fixed-btn" type="button">üèÜ TOP PILOTS</button>
    <button id="fsEnterBtn" class="fixed-btn" type="button">FULLSCREEN</button>
    <button id="shopBtn" type="button">üîß MECH FORGE</button>
    <button id="pauseBtn" class="fixed-btn hide" type="button">PAUSE</button>

<script>
(() => {
    const W = 960, H = 540;
    const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
    const collide = (a, b) => { const dx = a.x - b.x, dy = a.y - b.y; const rr = (a.r || 0) + (b.r || 0); return dx*dx + dy*dy < rr*rr; };
    const API_BASE = "https://zero-june-worship-developed.trycloudflare.com/api"; 
    const q = (id) => document.getElementById(id);
    const cvs = q('game'), ctx = cvs.getContext('2d'), stage = q('stage');
    new ResizeObserver(() => { const r=stage.getBoundingClientRect(),cssW=Math.floor(r.width),cssH=Math.floor(r.height),dpr=Math.max(1,Math.min(2,window.devicePixelRatio||1));cvs.style.width=cssW+'px';cvs.style.height=cssH+'px';cvs.width=Math.floor(cssW*dpr);cvs.height=Math.floor(cssH*dpr);ctx.setTransform(cvs.width/W,0,0,cvs.height/H,0,0); }).observe(stage);
    const mouse = { x: W / 2, y: H * 0.8 };
    const pointFromEvent = (e) => { const r=cvs.getBoundingClientRect(),cx='clientX' in e?e.clientX:e.touches[0].clientX,cy='clientY' in e?e.clientY:e.touches[0].clientY; return { x:(cx-r.left)*(W/r.width), y:(cy-r.top)*(H/r.height) }; };
    cvs.addEventListener('mousemove', (e) => { const p = pointFromEvent(e); mouse.x = p.x; mouse.y = p.y; });
    cvs.addEventListener('touchstart', (e) => { const p = pointFromEvent(e); mouse.x = p.x; mouse.y = p.y; e.preventDefault(); }, { passive:false });
    cvs.addEventListener('touchmove',  (e) => { const p = pointFromEvent(e); mouse.x = p.x; mouse.y = p.y; e.preventDefault(); }, { passive:false });

    const BGM_NORMAL = 'https://vgmsite.com/soundtracks/f-zero-x-guitar-arrange/mpkjsgyj/01%20-%20Mute%20City.mp3';
    const BGM_BOSS = 'https://vgmsite.com/soundtracks/doom-2016-ost/eblnhwtr/105.%20BFG%20Division.mp3';
    const bgm = q('bgmAudio');
    let musicFadeInterval;

    function playSound(src, volume = 0.5) {
        const audio = new Audio(src);
        audio.volume = volume;
        audio.play().catch(e => {});
    }

    function playMusic(src, volume = 0.5) {
        const currentSrcEnd = bgm.src.split('/').pop();
        const newSrcEnd = src.split('/').pop();
        if (currentSrcEnd === newSrcEnd && !bgm.paused && bgm.volume > 0) return;
        clearInterval(musicFadeInterval);
        let currentVolume = bgm.volume;
        if (bgm.paused || bgm.src === '' || currentVolume === 0) {
            bgm.src = src; bgm.volume = volume; bgm.play().catch(e => {}); return;
        }
        musicFadeInterval = setInterval(() => {
            currentVolume = Math.max(0, currentVolume - 0.05);
            bgm.volume = currentVolume;
            if (currentVolume <= 0) {
                clearInterval(musicFadeInterval); bgm.pause(); bgm.src = src; bgm.volume = volume; bgm.play().catch(e => {});
            }
        }, 50);
    }

    const store = {
        frame: 0, last: performance.now(), isGameOver: false, isPaused: false,
        world: { wave: 1, score: 0, shards: 0, xp: 0, level: 1, kills: 0, bosses: 0 },
        player: { x: W * 0.5, y: H * 0.8, r: 14, hp: 100, hpMax: 100, fireT: 0, speed: 380, dmgMult: 1, fireRate: 0.18, vampirism: 0, shield: 0, shieldMax: 0, multishot: 1, piercing: 0, explosive: false },
        boss: null, bullets: [], eBullets: [], enemies: [],
        _startTs: performance.now()
    };
    
    const player_initial_state = { x: W * 0.5, y: H * 0.8, r: 14, hp: 100, hpMax: 100, fireT: 0, speed: 380, dmgMult: 1, fireRate: 0.18, vampirism: 0, shield: 0, shieldMax: 0, multishot: 1, piercing: 0, explosive: false };

    const UPGRADES = [
        { id: 'dmg', name: 'PLASMA CORE', desc: '+25% damage', cost: 0, tier: 1, apply: () => store.player.dmgMult *= 1.25 },
        { id: 'speed', name: 'NEURAL BOOST', desc: '+15% speed', cost: 0, tier: 1, apply: () => store.player.speed *= 1.15 },
        { id: 'hp', name: 'BLOOD ARMOR', desc: '+10 max HP', cost: 0, tier: 1, apply: () => { store.player.hpMax += 10; store.player.hp += 10; } },
        { id: 'fire', name: 'OVERCLOCK', desc: '+25% fire rate', cost: 0, tier: 1, apply: () => store.player.fireRate *= 0.75 },
        { id: 'vamp', name: 'VAMPIRIC ROUNDS', desc: 'Heal 0.5% damage dealt', cost: 0, tier: 1, apply: () => store.player.vampirism += 0.005 },
        { id: 'multi', name: 'SCATTER PROTOCOL', desc: '+1 projectile', cost: 0, tier: 1, apply: () => store.player.multishot += 1 },
        { id: 'pierce', name: 'PHASE ROUNDS', desc: 'Bullets pierce enemies', cost: 0, tier: 1, apply: () => store.player.piercing = 1 },
        { id: 'shield', name: 'VOID SHIELD', desc: '+20 regenerating shield', cost: 0, tier: 1, apply: () => { store.player.shieldMax += 20; store.player.shield = store.player.shieldMax; } },
        { id: 'explode', name: 'NOVA WARHEADS', desc: 'Explosive rounds', cost: 0, tier: 1, apply: () => store.player.explosive = true },
        
        { id: 'dmg-t2', name: 'REINFORCED PLASMA', desc: '+15% damage', cost: 40, tier: 2, apply: () => store.player.dmgMult *= 1.15 },
        { id: 'speed-t2', name: 'SPEED REGULATOR', desc: '+10% speed', cost: 35, tier: 2, apply: () => store.player.speed *= 1.1 },
        { id: 'hp-t2', name: 'REPAIR NANOBOTS', desc: 'Restore 25 HP', cost: 20, tier: 2, apply: () => store.player.hp=Math.min(store.player.hpMax,store.player.hp+25) },
        { id: 'shield-t2', name: 'SHIELD BOOSTER', desc: '+20 shield capacity', cost: 30, tier: 2, apply: () => { store.player.shieldMax+=20; store.player.shield+=20; } },
        
        { id: 'dmg-t3', name: 'BASIC RECOIL', desc: '+10% damage', cost: 10, tier: 3, apply: () => store.player.dmgMult *= 1.1 },
        { id: 'speed-t3', name: 'THRUSTER OPTIMIZATION', desc: '+5% speed', cost: 8, tier: 3, apply: () => store.player.speed *= 1.05 },
        { id: 'hp-t3', name: 'COMPOSITE PLATING', desc: '+5 max HP', cost: 5, tier: 3, apply: () => { store.player.hpMax += 5; store.player.hp += 5; } }
    ];

    function getUpgradesByTier(tier) {
        return UPGRADES.filter(u => u.tier === tier);
    }

    function initWave() {
        const isBossWave = store.world.wave % 5 === 0;
        if (isBossWave) {
            store.enemies = []; 
            const bossHpScale = store.world.wave / 5;
            store.boss = createBoss(bossHpScale);
            announce(`‚ö° GUARDIAN: ${store.boss.name} ‚ö°`); 
            playMusic(BGM_BOSS, 0.6);
        } else {
            store.enemies = [];
            const spawnCount = 6 + Math.floor(store.world.wave * 1.5);
            for (let i = 0; i < spawnCount; i++) {
                const types = ['drone', 'drone', 'hunter', 'phantom', 'mech'];
                store.enemies.push(spawnEnemy(types[Math.floor(Math.random() * types.length)]));
            }
            announce(`‚ó¢ SECTOR ${store.world.wave} ‚ó£`); 
            playMusic(BGM_NORMAL, 0.5);
        }
    }

    function createBoss(scale) {
        const types = [
            { name:'VOID DRIFTER', baseHp: 800 },
            { name:'OMEGA SENTINEL', baseHp: 1000 },
            { name:'CORE MALIGNUS', baseHp: 1200 }
        ];
        const type = types[Math.min(Math.floor(store.world.wave / 5) -1, types.length - 1)];
        const hp = type.baseHp * scale;
        return { ...type, x: W/2, y: -80, r: 50, hpMax: hp, color:'#b266ff', hp: hp, t: 0, fireT: 0, moveT: 0, vx: 100, vy: 30 };
    }

    function spawnEnemy(type='drone') {
        const cfgs = {
            drone:  { r:10, v:80,  hp:20,  color:'#c27cff', xp:5, score:50,  shards:1, fireRateChance: 0.004 },
            hunter: { r:12, v:160, hp:25,  color:'#ff8080', xp:8, score:80,  shards:2, fireRateChance: 0.005 },
            phantom:{ r:14, v:100, hp:30,  color:'#9a66ff', xp:10,score:100, shards:2, fireRateChance: 0.006, fireCooldown: 1.5 },
            mech:   { r:18, v:50,  hp:80,  color:'#7a49cc', xp:15,score:150, shards:3, fireRateChance: 0.007 }
        };
        let c = { ...cfgs[type] };
        const wave = store.world.wave;
        if (wave > 1) {
            c.hp *= 1 + (wave * 0.05);
            c.fireRateChance *= 1 + (wave * 0.05);
        }
        c.shards = Math.ceil(c.shards / 2);
        return { ...c, type, x:20+Math.random()*(W-40), y:-50-Math.random()*250, hpMax:c.hp, phase:type==='phantom', t:0, fireT: (c.fireCooldown || 0), isBursting: false, burstTimer: 0 };
    }

    function stepPlayer(dt) {
        const p = store.player;
        const vx = mouse.x - p.x, vy = mouse.y - p.y;
        p.x += (vx * p.speed * dt * 0.005);
        p.y += (vy * p.speed * dt * 0.005);
        
        p.x = clamp(p.x, 20, W - 20);
        p.y = clamp(p.y, 20, H - 20);

        p.fireT -= dt;
        if (p.fireT <= 0) { firePlayer(); p.fireT = p.fireRate; }
        if (p.shieldMax > 0 && p.shield < p.shieldMax) { p.shield = Math.min(p.shieldMax, p.shield + 4 * dt); }
    }
    
    function stepWorld(dt) {
        stepPlayer(dt);
        if(store.boss) stepBoss(dt);

        store.eBullets.forEach(b => { b.x += b.vx*dt; b.y += b.vy*dt; if (b.x < -20 || b.x > W+20 || b.y < -20 || b.y > H+20) b.dead = true; if (collide(b, store.player)) { takeDamage(b.dmg||10); b.dead = true; }});
        
        store.enemies.forEach(e => {
            e.t += dt; e.y += e.v * dt;
            if (e.phase) { e.x = e.x + Math.sin(e.t*3) * 80*dt; }
            if (e.y > H+30 || e.x < -30 || e.x > W+30) e.dead = true;
            if (collide(e, store.player)) { takeDamage(15); e.dead = true; }

            if (e.isBursting) {
                e.burstTimer -= dt;
                if (e.burstTimer <= 0) {
                    if (!e.dead) store.eBullets.push({ x:e.x, y:e.y, vx:0, vy:180, r:3, col:e.color, dmg:8 });
                    e.isBursting = false;
                }
            }

            e.fireT -= dt;
            if (e.fireT <= 0 && e.y > 0 && !e.isBursting && Math.random() < e.fireRateChance) {
                switch(e.type) {
                    case 'hunter':
                        const angleToPlayer = Math.atan2(store.player.y - e.y, store.player.x - e.x);
                        store.eBullets.push({ x:e.x, y:e.y, vx:Math.cos(angleToPlayer)*180, vy:Math.sin(angleToPlayer)*180, r:3, col:e.color, dmg:10 });
                        e.fireT = 1.0;
                        break;
                    case 'phantom':
                        store.eBullets.push({ x:e.x, y:e.y, vx:0, vy:180, r:3, col:e.color, dmg:8 });
                        e.isBursting = true;
                        e.burstTimer = 0.1;
                        e.fireT = e.fireCooldown;
                        break;
                    case 'mech':
                        for (let i = -1; i <= 1; i++) {
                            const angle = (90 + i * 15) * Math.PI / 180;
                            store.eBullets.push({ x:e.x, y:e.y, vx:Math.cos(angle)*140, vy:Math.sin(angle)*140, r:4, col:e.color, dmg:12 });
                        }
                        e.fireT = 2.0;
                        break;
                    default: // Drone
                        store.eBullets.push({ x:e.x, y:e.y, vx:0, vy:150, r:3, col:e.color, dmg:8 });
                        e.fireT = 0.5;
                }
            }
        });

        store.bullets.forEach(b => {
            b.x += b.vx*dt; b.y += b.vy*dt; if (b.x < -20 || b.x > W+20 || b.y < -20 || b.y > H+20) b.dead = true;
            store.enemies.forEach(e => { if (!e.dead && collide(b,e)) {
                const dmg = b.dmg || 20; e.hp -= dmg;
                if (e.hp <= 0) { e.dead = true; store.world.score += e.score; store.world.shards += e.shards; store.world.xp += e.xp; store.world.kills++; if (store.player.vampirism > 0) store.player.hp = Math.min(store.player.hpMax, store.player.hp + dmg * store.player.vampirism); explode(e.x, e.y); }
                if (b.explosive) explode(b.x,b.y); if (!b.pierce) b.dead = true;
            }});
            if (store.boss && collide(b, store.boss)) {
                const dmg = b.dmg || 20; store.boss.hp -= dmg;
                if (store.boss.hp <= 0) { store.world.score += 2000; store.world.shards += 25; store.world.xp += 100; store.world.bosses++; store.boss = null; announce('‚ö° GUARDIAN DEFEATED ‚ö°'); explode(b.x, b.y); playMusic(BGM_NORMAL); }
                if (b.explosive) explode(b.x,b.y); if (!b.pierce) b.dead = true;
            }
        });

        store.bullets = store.bullets.filter(b => !b.dead); store.eBullets = store.eBullets.filter(b => !b.dead);
        store.enemies = store.enemies.filter(e => !e.dead);
        if (!store.boss && store.enemies.length === 0) { 
            store.world.wave++;
            initWave();
        }

        const xpNeeded = store.world.level * 100; if (store.world.xp >= xpNeeded) { store.world.xp -= xpNeeded; store.world.level++; levelUp(); }
        if (store.player.hp <= 0) handleGameOver();
    }

    function explode(x,y) { playSound('https://soundbible.com/mp3/Bomb-SoundBible.com-891110113.mp3', 0.4); }

    function drawEnemy(e) {
        const { x, y, r, type, color, hp, hpMax, t } = e;
        ctx.save(); ctx.translate(x, y);
        if (hp < hpMax && hp > 0) { ctx.fillStyle = 'rgba(0,0,0,0.5)'; ctx.fillRect(-r, -r-8, r*2, 3); ctx.fillStyle = '#b266ff'; ctx.fillRect(-r, -r-8, r*2*(hp/hpMax), 3); }
        ctx.strokeStyle = color; ctx.fillStyle = color + '99'; ctx.lineWidth = 2;
        ctx.beginPath();
        switch(type) {
            case 'drone': ctx.moveTo(0,-r); ctx.lineTo(r,r*0.2); ctx.lineTo(r*0.5,r); ctx.lineTo(-r*0.5,r); ctx.lineTo(-r,r*0.2); break;
            case 'hunter': ctx.moveTo(0,-r); ctx.lineTo(r,r); ctx.lineTo(0,r*0.5); ctx.lineTo(-r,r); break;
            case 'phantom': ctx.globalAlpha = 0.7 + 0.3 * Math.sin(t * 5); for (let i = 0; i < 6; i++) { const a = (i*Math.PI/3)+t, px=Math.cos(a)*r, py=Math.sin(a)*r; i===0?ctx.moveTo(px,py):ctx.lineTo(px,py); } break;
            case 'mech': ctx.rect(-r,-r*0.8,r*2,r*1.6); ctx.moveTo(-r,-r*0.8); ctx.lineTo(-r*1.2,-r*0.5); ctx.lineTo(-r,-r*0.2); ctx.moveTo(r,-r*0.8); ctx.lineTo(r*1.2,-r*0.5); ctx.lineTo(r,-r*0.2); break;
        }
        ctx.closePath(); ctx.fill(); ctx.stroke(); ctx.restore();
    }
    
    function levelUp() {
        announce(`‚ö° LEVEL ${store.world.level} REACHED ‚ö°`);
        store.isPaused = true;
        const panel = q('levelPanel'), grid = q('skillsGrid');
        const available = getUpgradesByTier(1);
        const choices = [];

        for (let i = available.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [available[i], available[j]] = [available[j], available[i]];
        }
        
        choices.push(...available.slice(0, 3));
        
        grid.innerHTML=choices.map(s=>`<div class="skill-card" data-id="${s.id}"><div class="skill-title">${s.name}</div><div class="skill-desc">${s.desc}</div></div>`).join('');
        grid.querySelectorAll('.skill-card').forEach(c=>{c.addEventListener('click',()=>{const id=c.dataset.id,upgrade=UPGRADES.find(s=>s.id===id);if(upgrade){upgrade.apply();} panel.classList.add('hide'); store.isPaused = false; initWave()})});
        panel.classList.remove('hide');
    }

    function handleGameOver() {
        if (store.isGameOver) return;
        store.isGameOver = true;
        bgm.pause();
        playSound('https://soundbible.com/mp3/Grenade-SoundBible.com-1775988413.mp3');
        addScore(store.world.score);
        announce('‚ó¢ NEXUS BREACH - PILOT LOST ‚ó£');
        q('finalScore').textContent = store.world.score;
        q('gameOverPanel').classList.remove('hide');
    }

    function resetGame() {
        bgm.src = '';
        store.player = { ...player_initial_state };
        store.world = { wave: 1, score: 0, shards: 0, xp: 0, level: 1, kills: 0, bosses: 0 };
        store.boss = null; store.enemies = []; store.bullets = []; store.eBullets = [];
        store._startTs = performance.now(); store.isGameOver = false;
        q('gameOverPanel').classList.add('hide');
        q('shopPanel').classList.add('hide');
        q('levelPanel').classList.add('hide');
        initWave();
    }

    function frame(now) {
        const dt = Math.min(0.033, (now - store.last)/1000);
        store.last = now;
        if (!store.isGameOver && !store.isPaused) {
            stepWorld(dt);
        }
        render(dt);
        requestAnimationFrame(frame);
    }

    function render(dt) {
        ctx.fillStyle='#050008'; ctx.fillRect(0,0,W,H);
        const time = performance.now() / 1000;
        const starsA = Array.from({ length: 100 }, () => ({ x: Math.random()*W, y: Math.random()*H, r: Math.random()*1.5, pulse: Math.random()*10 }));
        const starsB = Array.from({ length: 80 }, () => ({ x: Math.random()*W, y: Math.random()*H, r: Math.random()*2, pulse: Math.random()*10 }));
        ctx.globalAlpha = 0.8;
        for(const s of starsA) { s.y += 30 * dt; if (s.y > H) s.y -= H; ctx.fillStyle = `rgba(255,0,255,${0.5 + 0.5 * Math.sin(time * 2 + s.pulse)})`; ctx.beginPath(); ctx.arc(s.x, s.y, s.r, 0, 2 * Math.PI); ctx.fill(); }
        ctx.globalAlpha = 0.6;
        for(const s of starsB) { s.y += 60 * dt; if (s.y > H) s.y -= H; ctx.fillStyle = `rgba(204,0,255,${0.4 + 0.6 * Math.sin(time * 1.5 + s.pulse)})`; ctx.beginPath(); ctx.arc(s.x, s.y, Math.max(0.1, s.r * (0.4 + 0.6 * Math.sin(time * 1.5 + s.pulse))), 0, 2 * Math.PI); ctx.fill(); }
        ctx.globalAlpha = 1;
        for(const b of store.eBullets) { ctx.fillStyle = b.col; ctx.beginPath(); ctx.arc(b.x, b.y, b.r, 0, 2 * Math.PI); ctx.fill(); }
        for(const b of store.bullets) { ctx.fillStyle = b.col; ctx.beginPath(); ctx.arc(b.x, b.y, b.r, 0, 2 * Math.PI); ctx.fill(); }
        for(const e of store.enemies) drawEnemy(e);
        if (store.boss) drawBoss(store.boss);
        drawShip(store.player.x, store.player.y);
        updateHUD();
    }
    
    function takeDamage(dmg) { const p = store.player; const a = Math.min(p.shield, dmg); p.shield -= a; dmg -= a; p.hp = Math.max(0, p.hp - dmg); }
    function escapeHtml(s){ s=String(s??''); return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')};
    function announce(text){ const el=q('announce'); el.textContent=text; el.classList.remove('hide'); clearTimeout(el._t); el._t=setTimeout(()=>el.classList.add('hide'), 2500)}
    function updateHUD(){
        q("hudWaveContent").innerHTML=`<div class="hud-title">‚ó¢ VOID SKIES ‚ó£</div><div style="text-align:center">SECTOR <b>${store.world.wave}</b> ‚Ä¢ KILLS <b>${store.world.kills}</b> ‚Ä¢ LVL <b>${store.world.level}</b></div>`;
        const t=store.player,e=Math.round(t.hp/t.hpMax*100),o=t.shieldMax>0?Math.round(t.shield/t.shieldMax*100):0;
        q("hudPilotContent").innerHTML=`<div class="hud-title">${store.name?`‚ó¢ ${escapeHtml(store.name)} ‚ó£`:"‚ó¢ UNIDENTIFIED ‚ó£"}</div><div style="text-align:center">SCORE <b>${store.world.score}</b> ‚Ä¢ SHARDS <b>${store.world.shards}</b></div><div class="bar"><span style="width:${e}%"></span></div>${t.shieldMax>0?`<div class="bar" style="margin-top:2px;"><span style="width:${o}%;background:linear-gradient(90deg,#80ffff,#66aaff)"></span></div>`:""}`;
        store.boss?(q("hudBossContent").classList.remove("hide"),q("hudBossContent").innerHTML=`<div class="hud-title">‚ö° ${store.boss.name} ‚ö°</div><div class="bar"><span style="width:${Math.round(store.boss.hp/store.boss.hpMax*100)}%"></span></div>`):q("hudBossContent").classList.add("hide");
    }
    
    function updateLeaderboard(top10) {
        q("hsList").innerHTML=(top10||[]).map(s=>`<li>${escapeHtml(s.name)} ‚Äî ${s.score} (Wave ${s.waves??"?"})</li>`).join("")||`<li>NO DATA</li>`;
        q("hsListPopup").innerHTML=(top10||[]).map((s,i)=>`<li>#${i+1} ${escapeHtml(s.name)} ‚Äî ${s.score} (Wave ${s.waves??"?"})</li>`).join("")||`<li>NO DATA</li>`;
    }
    
    async function refreshScoreList(){try{const res=await fetch(`${API_BASE}/leaderboard`,{cache:"no-store"});const data=await res.json();updateLeaderboard(data);}catch(err){console.error("Scores:",err)}}
    
    async function addScore(score){
        const name = (store.name || "ROGUE").slice(0, 16);
        try {
            const nonceRes = await fetch(`${API_BASE}/session`, { method: "POST" });
            const { nonce } = await nonceRes.json();
            const body = { name, score: Math.floor(score) || 0, waves: store.world.wave | 0, kills: store.world.kills | 0, bosses: store.world.bosses | 0, ms: Math.max(10_000, Math.floor(performance.now() - store._startTs)), nonce };
            const res = await fetch(`${API_BASE}/submit`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(body) });
            const data = await res.json();
            if (data.ok) {
                updateLeaderboard(data.top10);
            } else {
                console.warn("Score rejected:", data.err);
                announce(`Score rejected: ${data.err}`);
                refreshScoreList();
            }
        } catch (err) {
            console.error("Submit Error:", err);
            refreshScoreList();
        }
    }

    function firePlayer(){
        const p = store.player;
        const bulletSpeed = 420;
        const angleSpread = p.multishot > 2 ? 15 : 10;
        for(let i = 0; i < p.multishot; i++){
            const angle = (i - (p.multishot - 1) / 2) * angleSpread * Math.PI / 180;
            const vx = Math.sin(angle) * bulletSpeed;
            const vy = -Math.cos(angle) * bulletSpeed;
            store.bullets.push({
                x: p.x + 10 * Math.sin(angle),
                y: p.y - 12,
                vx: vx,
                vy: vy,
                r: p.explosive ? 5 : 3,
                col: p.explosive ? "#cc99ff" : "#b266ff",
                dmg: 20 * p.dmgMult,
                pierce: p.piercing,
                explosive: p.explosive
            });
        }
    }

    function stepBoss(dt){
        const b = store.boss;
        if(!b) return;
        b.t += dt;
        if(b.y < 100){
            b.y += b.vy * dt;
        } else {
            b.moveT += dt;
            b.x = W / 2 + 220 * Math.sin(1.2 * b.moveT);
            b.y = 100 + 60 * Math.sin(2 * b.moveT);
        }
        b.fireT += dt;
        if(b.fireT > 0.5){
            b.fireT = 0;
            const numBullets = 8;
            for(let i = 0; i < numBullets; i++){
                const angle = i * Math.PI / 4 + 2 * b.t;
                store.eBullets.push({
                    x: b.x + 30 * Math.cos(angle),
                    y: b.y + 30 * Math.sin(angle),
                    vx: 120 * Math.cos(angle),
                    vy: 120 * Math.sin(angle),
                    r: 5,
                    col: b.color,
                    dmg: 15
                });
            }
        }
    }
    
    function drawBoss(t){ctx.save(),ctx.translate(t.x,t.y),ctx.fillStyle="rgba(0,0,0,0.7)",ctx.fillRect(-60,-t.r-20,120,8),ctx.fillStyle=t.color,ctx.fillRect(-60,-t.r-20,120*(t.hp/t.hpMax),8),ctx.strokeStyle="#ff00ff",ctx.lineWidth=1,ctx.strokeRect(-60,-t.r-20,120,8),ctx.strokeStyle=t.color,ctx.lineWidth=3;for(let e=0;e<3;e++)ctx.save(),ctx.rotate(t.t*(1+.5*e)),ctx.beginPath(),ctx.arc(0,0,t.r-10*e,0,2*Math.PI),ctx.stroke(),ctx.restore();ctx.fillStyle=t.color+"aa",ctx.beginPath(),ctx.arc(0,0,Math.max(1,.3*t.r*(.8+.2*Math.sin(3*t.t))),0,2*Math.PI),ctx.fill(),ctx.restore()}
    function drawShip(t,e){ctx.save(),ctx.translate(t,e),ctx.beginPath(),ctx.moveTo(0,-20),ctx.lineTo(12,8),ctx.lineTo(8,14),ctx.lineTo(0,10),ctx.lineTo(-8,14),ctx.lineTo(-12,8),ctx.closePath();const o=ctx.createLinearGradient(0,-20,0,14);o.addColorStop(0,"#b266ff"),o.addColorStop(.5,"#7a49cc"),o.addColorStop(1,"#4d2a80"),ctx.fillStyle=o,ctx.fill(),ctx.lineWidth=2,ctx.strokeStyle="#c49cff",ctx.stroke(),ctx.strokeStyle="#b266ff",ctx.lineWidth=2,ctx.beginPath(),ctx.moveTo(-12,5),ctx.lineTo(-20,-2),ctx.lineTo(-18,8),ctx.moveTo(12,5),ctx.lineTo(20,-2),ctx.lineTo(18,8),ctx.stroke();const r=performance.now()/1e3;ctx.globalAlpha=.8+.2*Math.sin(10*r),ctx.fillStyle="#cc99ff",ctx.beginPath(),ctx.ellipse(-5,16,3,6,0,0,2*Math.PI),ctx.ellipse(5,16,3,6,0,0,2*Math.PI),ctx.fill(),ctx.globalAlpha=1,ctx.fillStyle="#ffffff",ctx.beginPath(),ctx.arc(0,-8,3,0,2*Math.PI),ctx.fill(),ctx.restore()}

    function showShop(){
        store.isPaused=true;
        q('pauseBtn').classList.add('hide');
        const panel = q("shopPanel"), grid = q("shopGrid"), shardsEl = q("shopShards");
        shardsEl.textContent = store.world.shards;
        
        const shopUpgrades = UPGRADES.filter(u => u.cost > 0);
        
        grid.innerHTML = shopUpgrades.map((u, i) => {
            const isDisabled = store.world.shards < u.cost;
            return `<div class="skill-card shop-item" data-idx="${i}" style="${isDisabled ? "opacity:0.5;pointer-events:none;" : ""}">
                <div class="skill-title">${u.name}</div>
                <div class="skill-desc">${u.desc}</div>
                <div style="color:var(--accent);margin-top:4px;">Cost: ${u.cost} shards</div>
            </div>`;
        }).join("");
        
        grid.querySelectorAll(".shop-item").forEach(item => {
            item.addEventListener("click", () => {
                const index = parseInt(item.dataset.idx);
                const upgrade = shopUpgrades[index];
                if(store.world.shards >= upgrade.cost){
                    store.world.shards -= upgrade.cost;
                    upgrade.apply();
                    showShop();
                }
            });
        });
        panel.classList.remove("hide");
    }

    function ensureName(){if(!store.name){store.isPaused=true,q("namePanel").classList.remove("hide"),q("nameInput").value="",setTimeout(()=>q("nameInput").focus(),50)}}
    
    q("restartBtn").addEventListener("click",resetGame);
    q("saveName").addEventListener("click",()=>{const t=(q("nameInput").value||"").slice(0,16).trim();t&&(store.name=t,q("namePanel").classList.add("hide"),store.isPaused=!1, initWave())});
    q("closeShop").addEventListener("click",()=>{q("shopPanel").classList.add('hide'); store.isPaused=false; q('pauseBtn').classList.remove('hide'); initWave()});
    q("shopBtn").addEventListener("click", showShop);
    
    q("menuBtn").addEventListener("click",()=>{
        store.isPaused=true;
        q('scorePanel').classList.remove('hide');
        q('pauseBtn').classList.add('hide');
    });
    q("closeScores").addEventListener("click",()=>{
        store.isPaused=false;
        q('scorePanel').classList.add('hide');
        q('pauseBtn').classList.remove('hide');
    });
    
    q("fsEnterBtn").addEventListener('click', () => {
        const root = document.documentElement;
        if (root.requestFullscreen) {
            root.requestFullscreen();
        } else if (root.webkitRequestFullscreen) {
            root.webkitRequestFullscreen();
        } else if (root.msRequestFullscreen) {
            root.msRequestFullscreen();
        }
    });
    
    q('pauseBtn').addEventListener('click', () => {
        if (!store.isGameOver && q('shopPanel').classList.contains('hide') && q('levelPanel').classList.contains('hide') && q('namePanel').classList.contains('hide') && q('scorePanel').classList.contains('hide')) {
            store.isPaused = !store.isPaused;
            if (store.isPaused) {
                q('pauseBtn').textContent = 'RESUME';
            } else {
                q('pauseBtn').textContent = 'PAUSE';
            }
        }
    });

    addEventListener("keydown",t=>{const e=t.key.toLowerCase();if("INPUT"===document.activeElement.tagName)return;"n"===e?(store.isPaused=!0,q("nameInput").value=store.name||"",q("namePanel").classList.remove("hide")):void 0});
    
    refreshScoreList();
    ensureName();
    requestAnimationFrame(frame);
    
})();
</script>
</body>
</html>
